#!/usr/bin/expect -f

#######################################################################
# Script Expect - ConfiguraÃ§Ã£o Nginx Automatizada
# Configura o Nginx no servidor Contabo
#######################################################################

set timeout 300
set server_ip "212.90.120.135"
set server_user "root"
set server_pass "1234"

puts "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
puts " âš™ï¸  Configurando Nginx no Servidor"
puts "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

# Upload da configuraÃ§Ã£o Nginx HTTP
puts "ğŸ“¤ Fazendo upload da configuraÃ§Ã£o Nginx...\n"
spawn scp nginx_contabo_http.conf $server_user@$server_ip:/etc/nginx/sites-available/ecokambio
expect {
    "password:" {
        send "$server_pass\r"
        exp_continue
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
    eof
}

puts "\nâœ… ConfiguraÃ§Ã£o enviada\n"

# Ativar site e recarregar Nginx
puts "ğŸ”§ Ativando site no Nginx...\n"
spawn ssh $server_user@$server_ip {
    ln -sf /etc/nginx/sites-available/ecokambio /etc/nginx/sites-enabled/ && \
    rm -f /etc/nginx/sites-enabled/default && \
    nginx -t && \
    systemctl reload nginx && \
    systemctl status nginx
}
expect {
    "password:" {
        send "$server_pass\r"
        exp_continue
    }
    eof
}

puts "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
puts " âœ… Nginx configurado com sucesso!"
puts "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
puts "ğŸŒ Teste: http://ecokambio.com"
puts "ğŸŒ Ou: http://$server_ip\n"
puts "ğŸ“ PrÃ³ximo passo: Instalar SSL"
puts "    Execute: expect scripts/install_ssl.exp\n"
