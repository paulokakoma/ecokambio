<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  
    <meta name="description"
        content="EcoKambio: Consulte taxas de c√¢mbio em Angola hoje. D√≥lar, euro e outras divisas em tempo real. Compare cota√ß√µes de bancos (BAI, BFA, BPC, BIC) e mercado informal (kinguilas). Calculadora gr√°tis de custos de importa√ß√£o.">
    <meta name="keywords"
        content="cambio angola hoje, dolar angola hoje, euro angola hoje, taxa cambio angola, ecokambio, cambio kwanza dolar, cambio kwanza euro, mercado informal angola, kinguilas angola, pre√ßo dolar hoje, cotacao euro angola, taxas bancarias angola, calculadora importa√ß√£o angola, cambio luanda">

    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="mKkaUaIb7qgtdmOu_NnH2BqK6sUMVnhk6JPAcmNfEpA" />

    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-7407113762962919">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7407113762962919"
        crossorigin="anonymous"></script>

    <!-- Brand Recognition -->
    <meta property="og:site_name" content="EcoKambio">
    <meta name="application-name" content="EcoKambio">
    <meta http-equiv="content-language" content="pt-AO">
    <meta name="revisit-after" content="1 days">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-N88ZM46F');</script>
    <!-- End Google Tag Manager -->



    <!-- Google tag (gtag.js) - Managed by cookie-consent.js -->


    <!-- Search Engine Verification Tags -->
    <meta name="msvalidate.01" content="9B55CD81FEFDBFC5B628211078350C6D" />
    <!-- <meta name="yandex-verification" content="SEU_CODIGO_YANDEX_AQUI" /> -->

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ecokambio.com/">
    <meta property="og:title" content="C√¢mbio Angola Hoje - Taxas D√≥lar Kwanza, Euro Kwanza | EcoKambio">
    <meta property="og:description"
        content="Consulte as taxas de c√¢mbio do d√≥lar, euro e outras divisas em Angola. Compare o mercado formal (bancos) e informal (kinguilas) em tempo real.">
    <meta property="og:image" content="https://ecokambio.com/assets/social-share-banner.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ecokambio.com/">
    <meta property="twitter:title" content="C√¢mbio Angola Hoje - Taxas D√≥lar Kwanza, Euro Kwanza | EcoKambio">
    <meta property="twitter:description"
        content="Consulte as taxas de c√¢mbio do d√≥lar, euro e outras divisas em Angola. Compare o mercado formal (bancos) e informal (kinguilas) em tempo real.">
    <meta property="twitter:image" content="https://ecokambio.com/assets/social-share-banner.png">

    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "WebPage",
          "@id": "https://ecokambio.com/#webpage",
          "url": "https://ecokambio.com/",
          "name": "EcoKambio - Plataforma de Taxas de C√¢mbio em Angola",
          "isPartOf": {
            "@id": "https://ecokambio.com/#website"
          },
          "about": {
            "@id": "https://ecokambio.com/#organization"
          },
          "primaryImageOfPage": {
            "@id": "https://ecokambio.com/#logo"
          },
          "description": "Consulte as taxas de c√¢mbio do d√≥lar, euro e outras divisas em Angola. Compare o mercado formal (bancos) e informal (kinguilas) em tempo real.",
          "inLanguage": "pt-PT"
        },
        {
          "@type": "WebSite",
          "@id": "https://ecokambio.com/#website",
          "url": "https://ecokambio.com",
          "name": "EcoKambio",
          "description": "Plataforma de Taxas de C√¢mbio em Angola",
          "publisher": {
            "@id": "https://ecokambio.com/#organization"
          },
          "potentialAction": {
            "@type": "SearchAction",
            "target": {
              "@type": "EntryPoint",
              "urlTemplate": "https://ecokambio.com/?q={search_term_string}"
            },
            "query-input": "required name=search_term_string"
          },
          "inLanguage": "pt-PT"
        },
        {
          "@type": "Organization",
          "@id": "https://ecokambio.com/#organization",
          "name": "Moko Tech, Sociedade por Quotas",
          "alternateName": "EcoKambio",
          "url": "https://ecokambio.com",
          "logo": {
            "@type": "ImageObject",
            "@id": "https://ecokambio.com/#logo",
            "url": "https://ecokambio.com/assets/main-logo.svg",
            "contentUrl": "https://ecokambio.com/assets/main-logo.svg",
            "width": 512,
            "height": 512,
            "caption": "EcoKambio Logo"
          },
          "image": {
            "@id": "https://ecokambio.com/#logo"
          },
          "sameAs": [
            "https://www.facebook.com/ecokambio",
            "https://www.instagram.com/ecokambio"
          ],
          "telephone": "+244938948994",
          "address": {
            "@type": "PostalAddress",
            "addressLocality": "Ca√°la",
            "addressRegion": "Huambo",
            "addressCountry": "AO"
          }
        },
        {
          "@type": "FinancialService",
          "@id": "https://ecokambio.com/#service",
          "name": "EcoKambio",
          "description": "Consulte as taxas de c√¢mbio do d√≥lar, euro e outras divisas em Angola. Compare o mercado formal (bancos) e informal (kinguilas) em tempo real.",
          "url": "https://ecokambio.com",
          "logo": {
            "@id": "https://ecokambio.com/#logo"
          },
          "image": {
            "@id": "https://ecokambio.com/#logo"
          },
          "provider": {
            "@id": "https://ecokambio.com/#organization"
          },
          "areaServed": {
            "@type": "Country",
            "name": "Angola"
          },
          "address": {
            "@type": "PostalAddress",
            "addressLocality": "Ca√°la",
            "addressRegion": "Huambo",
            "addressCountry": "AO"
          },
          "serviceType": "Currency Exchange Rates",
          "priceRange": "Gr√°tis"
        },
        {
          "@type": "BreadcrumbList",
          "@id": "https://ecokambio.com/#breadcrumb",
          "itemListElement": [
            {
              "@type": "ListItem",
              "position": 1,
              "name": "In√≠cio",
              "item": "https://ecokambio.com/"
            }
          ]
        }
      ]
    }
    </script>
    <link rel="canonical" href="https://ecokambio.com/" />
    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="/manifest.json">
    <!-- 1. CSS Cr√≠tico: Incorpore aqui o CSS m√≠nimo para a primeira dobra da p√°gina -->
    <style>
        /* Cole aqui o CSS cr√≠tico gerado pela ferramenta. Ex: body, header, etc. */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            min-height: 100vh
        }

        header {
            background-color: #fff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, .05)
        }
    </style>
    <!-- 2. Carregue o resto do CSS de forma n√£o-bloqueante -->
    <link rel="stylesheet" href="/css/output.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="/css/output.css">
    </noscript>

    <!-- Preconnect to critical third-party origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://drkjkkpzujwnkghtdokz.supabase.co" />

    <!-- Load fonts with display=swap to prevent layout shift -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" />

    <!-- Defer Supabase client loading -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --theme-color: #19b57f;
        }

        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            min-height: 100vh;
        }

        .market-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        }

        /* Carousel arrows */
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 30;
            background: rgba(15, 23, 42, 0.6);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        @media (min-width: 768px) {
            .carousel-arrow {
                width: 40px;
                height: 40px;
                border-radius: 8px;
            }
        }

        .carousel-arrow:hover {
            background: rgba(15, 23, 42, 0.8);
        }

        /* Dimens√µes responsivas dos banners baseadas em 1500x530 */
        .banner-container {
            /* Propor√ß√£o 3:1 para aumentar a altura relativa */
            aspect-ratio: 3 / 1;
            max-width: 1141px;
            width: 100%;
            padding: 2px;
            /* Reduz o espa√ßo interno para o conte√∫do */
            box-sizing: border-box;
            /* Garante que o padding seja aplicado para dentro */
        }

        .calculator-card {
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.3);
            transition: all 0.5s ease-in-out;
            border-radius: 24px;
        }

        .theme-bai {
            background-image: linear-gradient(to bottom, #0194b3, #006c6e, #b56b3e);
        }

        .theme-bfa {
            background-image: radial-gradient(circle, #f7931e, #eb5c28);
        }

        .theme-bic {
            background-image: linear-gradient(to right, #d42128, #2b2b2b);
        }

        .theme-bpc {
            background-image: linear-gradient(to right, #00529b, #00417a);
        }

        .theme-bci {
            background-color: #1f3a38;
        }

        .theme-yetu {
            background-image: linear-gradient(135deg, #00401A, #EAA900);
        }

        .theme-default {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
        }

        .border-theme-bai {
            border-color: #0194b3;
        }

        .text-theme-bai {
            color: #0194b3;
        }

        .border-theme-bfa {
            border-color: #f7931e;
        }

        .text-theme-bfa {
            color: #f7931e;
        }

        .border-theme-bic {
            border-color: #d42128;
        }

        .text-theme-bic {
            color: #d42128;
        }

        .border-theme-bpc {
            border-color: #00529b;
        }

        .text-theme-bpc {
            color: #00529b;
        }

        .border-theme-bci {
            border-color: #1f3a38;
        }

        .text-theme-bci {
            color: #1f3a38;
        }

        .border-theme-yetu {
            border-color: #EAA900;
        }

        .text-theme-yetu {
            color: #EAA900;
        }

        .border-theme-default {
            border-color: #3b82f6;
        }

        .text-theme-default {
            color: #3b82f6;
        }

        .border-theme-bna {
            border-color: #64748b;
        }

        .text-theme-bna {
            color: #64748b;
        }

        .bg-theme-bai-faded {
            background-color: rgba(1, 148, 179, 0.07);
        }

        .bg-theme-bfa-faded {
            background-color: rgba(247, 147, 30, 0.07);
        }

        .bg-theme-bic-faded {
            background-color: rgba(212, 33, 40, 0.07);
        }

        .bg-theme-bpc-faded {
            background-color: rgba(0, 82, 155, 0.07);
        }

        .bg-theme-bci-faded {
            background-color: rgba(31, 58, 56, 0.07);
        }

        .bg-theme-yetu-faded {
            background-color: rgba(234, 169, 0, 0.07);
        }

        .bg-theme-default-faded {
            background-color: rgba(59, 130, 246, 0.07);
        }

        .bg-theme-bna-faded {
            background-color: rgba(100, 116, 139, 0.07);
        }

        .market-header {
            color: var(--theme-color);
            transition: color 0.5s ease;
        }

        .tab-button {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .tab-active {
            background-color: var(--theme-color);
            color: white;
            transform: scale(1.03);
            box-shadow: 0 12px 30px rgba(25, 181, 127, 0.2);
        }

        .tab-inactive {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        .tab-inactive:hover {
            background-color: #d1d5db;
        }

        .calc-input {
            font-family: 'JetBrains Mono', monospace;
        }

        .province-tab {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .province-tab-active {
            border-color: var(--theme-color);
            color: var(--theme-color);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            50% {
                opacity: .6;
            }
        }

        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e5e7eb;
            /* gray-200 */
            border-radius: 0.5rem;
            /* rounded-lg */
        }

        .skeleton-dark {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #4b5563;
            /* gray-600 */
            border-radius: 0.5rem;
            /* rounded-lg */
        }

        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--theme-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            transition: color 0.5s ease;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes scroll-left {}

        .animate-scroll {
            /* Anima√ß√£o infinita - move 33.33% (1/3) da dist√¢ncia total j√° que temos 3 c√≥pias */
            animation: scroll 40s linear infinite;
        }

        /* Otimiza√ß√£o de performance para anima√ß√£o suave */
        .scrolling-content {
            will-change: transform;
            transform: translateZ(0);
        }

        /* Carousel arrows and helpers */
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 30;
            background: rgba(15, 23, 42, 0.6);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .carousel-arrow:hover {
            background: rgba(15, 23, 42, 0.8);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <style>
        /* Anima√ß√µes para a troca de moeda */
        @keyframes slide-out-left {
            to {
                transform: translateX(-20px);
                opacity: 0;
            }
        }

        @keyframes slide-out-right {
            to {
                transform: translateX(20px);
                opacity: 0;
            }
        }

        @keyframes slide-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Fade In Animation for smooth loading */
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Anima√ß√£o do logo Visa no header */
        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
            }

            14% {
                transform: scale(1.1);
            }

            28% {
                transform: scale(1);
            }

            42% {
                transform: scale(1.1);
            }

            70% {
                transform: scale(1);
            }
        }

        .visa-heartbeat img {
            animation: heartbeat 2.5s infinite;
        }

        .slide-out-left {
            animation: slide-out-left 0.2s ease-out forwards;
        }

        .slide-out-right {
            animation: slide-out-right 0.2s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N88ZM46F" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->



    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center">
            <a href="/" class="flex items-center space-x-2 md:space-x-3 hover:opacity-80 transition-opacity">
                <img src="/assets/main-logo.svg" alt="EcoKambio - Plataforma de Taxas de C√¢mbio em Angola" width="56"
                    height="56" class="h-12 md:h-14 w-auto">
                <span class="text-lg md:text-xl font-bold text-emerald-600">EcoKambio</span>
            </a>
            <nav class="flex-1 flex justify-end items-center space-x-4 md:space-x-8 ml-auto">
                <a href="/visa" id="header-visa-btn"
                    class="visa-heartbeat flex flex-col items-center text-center transition-transform duration-300 hover:scale-105"
                    title="Adquira j√° o seu cart√£o Visa">
                    <picture>
                        <source srcset="/assets/visa.webp" type="image/webp">
                        <img src="/assets/visa.png" alt="Cart√£o Visa Virtual para compras online" width="127"
                            height="80" class="h-14 md:h-20 w-auto rounded-md shadow-md" style="aspect-ratio: 127/80;"
                            fetchpriority="high">
                    </picture>
                    <span class="text-xs md:text-sm font-bold text-emerald-700 mt-1">Adquira j√° o teu Visa</span>
                </a>
            </nav>
        </div>
    </header>

    <!-- SEO-friendly content (hidden visually, visible to crawlers) -->
    <div class="sr-only" aria-hidden="false">
        <p>
            Bem-vindo ao EcoKambio, a plataforma l√≠der em taxas de c√¢mbio em Angola.
            Consulte gratuitamente as cota√ß√µes atualizadas do d√≥lar americano (USD) e euro (EUR)
            em rela√ß√£o ao kwanza angolano (AOA).
        </p>
        <p>
            Compare as taxas dos principais bancos comerciais de Angola com o mercado informal (kinguilas) em tempo
            real.
            Nossa calculadora permite estimar o custo total de compras internacionais, incluindo taxas e comiss√µes.
        </p>
    </div>
    <div class="text-center mb-8">
        <div class="grid grid-cols-2 gap-4 rounded-3xl bg-white shadow-md p-3" role="tablist">
            <button
                class="tab-button tab-active rounded-2xl py-4 px-4 md:px-8 text-sm md:text-base lg:text-lg font-bold focus:outline-none"
                id="market-tab" type="button" role="tab" aria-label="Ver taxas de c√¢mbio do mercado">üè¶
                Mercado</button>
            <button
                class="tab-button tab-inactive rounded-2xl py-4 px-4 md:px-8 text-sm md:text-base lg:text-lg font-bold focus:outline-none"
                id="calculator-tab" type="button" role="tab" aria-label="Abrir calculadora de custos de importa√ß√£o">üßÆ
                Calculadora</button>
        </div>
    </div>
    <section id="myTabContent">
        <div id="market-panel" role="tabpanel">
            <div class="mb-8 flex justify-center">
                <div class="flex space-x-2 bg-gray-200 p-2 rounded-full" role="tablist">
                    <button id="formal-market-tab-btn" role="tab" aria-label="Ver taxas do mercado formal (bancos)"
                        class="py-2 px-8 rounded-full font-semibold transition-all duration-300">Formal</button>
                    <button id="informal-market-tab-btn" role="tab"
                        aria-label="Ver taxas do mercado informal (kinguilas)"
                        class="py-2 px-8 rounded-full font-semibold transition-all duration-300">Informal</button>
                </div>
            </div>
            <div id="formal-market-panel" role="tabpanel">
                <div class="market-container p-6 md:p-8">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center">üèõÔ∏è MERCADO FORMAL</h3>
                        <p id="formal-market-timestamp" class="text-sm text-gray-500 mt-1 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Carregando...</span>
                        </p>
                    </div>

                    <!-- Novo Conversor de Moeda -->
                    <div id="quick-converter-container"
                        class="mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-200">
                        <h4 class="text-lg font-bold text-gray-700 mb-4">Conversor R√°pido <span
                                id="quick-converter-bank-name" class="text-emerald-600"></span></h4>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <!-- Campo de Valor -->
                            <div class="md:col-span-2">
                                <label for="quick-converter-amount"
                                    class="block text-sm font-medium text-gray-600">Valor</label>
                                <input type="text" id="quick-converter-amount" inputmode="decimal"
                                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg font-mono"
                                    placeholder="100,00">
                            </div>

                            <!-- Seletores de Moeda e Alternador -->
                            <div class="md:col-span-3 flex items-end gap-2">
                                <div class="flex-1">
                                    <label for="quick-converter-from" class="sr-only">De</label>
                                    <select id="quick-converter-from"
                                        class="custom-select mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg font-semibold">
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                        <option value="AOA">üá¶üá¥ AOA</option>
                                    </select>
                                </div>
                                <button id="quick-converter-switch"
                                    class="p-3 mb-0.5 bg-gray-200 hover:bg-gray-300 rounded-full transition-transform duration-300 focus:outline-none"><svg
                                        class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                    </svg></button>
                                <div class="flex-1">
                                    <label for="quick-converter-to" class="sr-only">Para</label>
                                    <select id="quick-converter-to"
                                        class="custom-select mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg font-semibold">
                                        <option value="AOA">üá¶üá¥ AOA</option>
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="quick-converter-result" class="mt-4 text-center text-2xl font-bold text-gray-800 h-8">
                        </div>
                    </div>

                    <div id="formal-market-grid"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 min-h-[200px]">
                        <!-- SKELETON LOADING (Est√°tico para feedback imediato) -->
                        <div class="p-4 rounded-xl border-l-4 border-gray-200 bg-gray-50 shadow-sm h-full">
                            <div class="skeleton h-6 w-1/4 mb-2"></div>
                            <div class="skeleton h-4 w-1/2 mb-6"></div>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 rounded-xl border-l-4 border-gray-200 bg-gray-50 shadow-sm h-full hidden sm:block">
                            <div class="skeleton h-6 w-1/4 mb-2"></div>
                            <div class="skeleton h-4 w-1/2 mb-6"></div>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 rounded-xl border-l-4 border-gray-200 bg-gray-50 shadow-sm h-full hidden lg:block">
                            <div class="skeleton h-6 w-1/4 mb-2"></div>
                            <div class="skeleton h-4 w-1/2 mb-6"></div>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="informal-market-panel" role="tabpanel" class="hidden">
                <div class="market-container p-6 md:p-8">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center">üè™ MERCADO INFORMAL</h3>
                        <p id="informal-market-timestamp" class="text-sm text-gray-500 mt-1 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Carregando...</span>
                        </p>
                    </div>

                    <!-- Conversor de Moeda para Mercado Informal -->
                    <div id="informal-converter-container"
                        class="mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-200">
                        <h4 class="text-lg font-bold text-gray-700 mb-4">Conversor Informal</h4>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="md:col-span-2">
                                <label for="informal-converter-amount"
                                    class="block text-sm font-medium text-gray-600">Valor</label>
                                <input type="text" id="informal-converter-amount" inputmode="decimal"
                                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg font-mono"
                                    placeholder="100,00">
                            </div>
                            <div class="md:col-span-3 flex items-end gap-2">
                                <div class="flex-1">
                                    <select id="informal-converter-from"
                                        class="custom-select mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg font-semibold"
                                        aria-label="De">
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                        <option value="USDT">ü™ô USDT</option>
                                        <option value="AOA">üá¶üá¥ AOA</option>
                                    </select>
                                </div>
                                <button id="informal-converter-switch"
                                    class="p-3 mb-0.5 bg-gray-200 hover:bg-gray-300 rounded-full transition-transform duration-300 focus:outline-none"><svg
                                        class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                    </svg></button>
                                <div class="flex-1">
                                    <select id="informal-converter-to"
                                        class="custom-select mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg font-semibold"
                                        aria-label="Para">
                                        <option value="AOA">üá¶üá¥ AOA</option>
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                        <option value="USDT">ü™ô USDT</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="informal-converter-result"
                            class="mt-4 text-center text-2xl font-bold text-gray-800 h-8"></div>
                    </div>

                    <!-- Sec√ß√µes de Kinguila e Casa de C√¢mbio -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Sec√ß√£o Kinguila -->
                        <div
                            class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-2xl border border-orange-200 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">ü™ô</span> Kinguila
                            </h4>
                            <div id="kinguila-grid" class="space-y-4">
                                <!-- SKELETON LOADING -->
                                <div class="bg-white/60 border border-orange-200 p-4 rounded-xl">
                                    <div class="skeleton h-5 w-3/4 mb-2"></div>
                                    <div class="skeleton h-8 w-1/2 mb-4"></div>
                                    <div class="mt-3 pt-3 border-t border-orange-200">
                                        <div class="skeleton h-4 w-full"></div>
                                    </div>
                                </div>
                                <div class="bg-white/60 border border-orange-200 p-4 rounded-xl">
                                    <div class="skeleton h-5 w-3/4 mb-2"></div>
                                    <div class="skeleton h-8 w-1/2 mb-4"></div>
                                    <div class="mt-3 pt-3 border-t border-orange-200">
                                        <div class="skeleton h-4 w-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sec√ß√£o Casa de C√¢mbio -->
                        <div
                            class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border border-blue-200 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">üè™</span> Casa de C√¢mbio
                            </h4>
                            <div id="casa-cambio-grid" class="space-y-4">
                                <!-- SKELETON LOADING -->
                                <div class="bg-white/60 border border-blue-200 p-4 rounded-xl">
                                    <div class="skeleton h-5 w-3/4 mb-2"></div>
                                    <div class="skeleton h-8 w-1/2 mb-4"></div>
                                    <div class="mt-3 pt-3 border-t border-blue-200">
                                        <div class="skeleton h-4 w-full"></div>
                                    </div>
                                </div>
                                <div class="bg-white/60 border border-blue-200 p-4 rounded-xl">
                                    <div class="skeleton h-5 w-3/4 mb-2"></div>
                                    <div class="skeleton h-8 w-1/2 mb-4"></div>
                                    <div class="mt-3 pt-3 border-t border-blue-200">
                                        <div class="skeleton h-4 w-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="calculator-panel" class="hidden" role="tabpanel">
            <div id="calculator-card-container" class="w-full max-w-xl mx-auto calculator-card min-h-[400px]">
                <!-- Skeleton para Calculadora -->
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div class="skeleton-dark h-9 w-3/4 mx-auto mb-3"></div>
                        <div class="skeleton-dark h-5 w-1/2 mx-auto"></div>
                    </div>
                    <div class="skeleton-dark h-6 w-1/3 mb-3"></div>
                    <div class="skeleton-dark h-16 w-full mb-6"></div>
                    <div class="skeleton-dark h-16 w-full"></div>
                </div>
            </div>
        </div>
    </section>
    </main>
    <!-- Sec√ß√£o de Apoiadores com altura m√≠nima para evitar CLS -->
    <section id="supporters-section" class="w-full bg-slate-50 pt-8 md:pt-12 pb-12 md:pb-16 mt-4 md:mt-8">
        <div class="w-full max-w-7xl mx-auto">
            <h2 class="text-4xl font-bold text-slate-800 text-center mb-12">Apoiadores</h2>
        </div>
        <div id="supporters-container-wrapper" class="relative w-full group">
            <!-- Bot√µes de navega√ß√£o -->
            <button id="supporter-prev"
                class="absolute left-4 top-1/2 -translate-y-1/2 z-20 bg-white/80 backdrop-blur-sm hover:bg-white/90 p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 group-hover:opacity-100 disabled:opacity-0">
                <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button id="supporter-next"
                class="absolute right-4 top-1/2 -translate-y-1/2 z-20 bg-white/80 backdrop-blur-sm hover:bg-white/90 p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 group-hover:opacity-100 disabled:opacity-0">
                <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            <!-- Container para Apoiadores -->
            <div id="supporters-carousel-container" class="relative overflow-hidden px-4 md:px-6">
                <div class="flex items-center justify-center w-full min-h-[150px] md:min-h-[250px]">
                    <div class="relative w-full banner-container rounded-2xl">
                        <div id="supporter-slides-wrapper"
                            class="flex h-full transition-transform duration-700 ease-in-out">
                            <!-- Skeleton Loader -->
                            <div id="supporter-skeleton"
                                class="supporter-slide flex-shrink-0 w-full h-full flex items-center justify-center">
                                <div class="skeleton h-full w-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicadores de slide -->
            <div id="supporter-indicators"
                class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 flex justify-center items-center gap-2 z-10">
            </div>
        </div>
    </section>

    <div class="bg-slate-800 text-slate-300">
        <!-- Sec√ß√£o de Afiliados movida para dentro de um div -->
        <div class="w-full max-w-7xl mx-auto px-6 pt-8 md:pt-12 pb-16">
            <h2 class="text-3xl font-bold text-white text-center mb-12">Parceiros</h2>
            <div id="affiliate-links-wrapper" class="relative group">
                <!-- Bot√£o de Recuar -->
                <button id="affiliate-prev-btn"
                    class="carousel-arrow left-0 md:-left-5 opacity-0 group-hover:opacity-100 transition-opacity">
                    &#x2190;
                </button>

                <!-- Container com scroll -->
                <div id="affiliate-links-container" class="flex overflow-x-auto no-scrollbar -mx-4 px-4">
                    <!-- Conte√∫do din√¢mico com espa√ßamento -->
                    <div id="affiliate-track" class="flex flex-shrink-0 gap-x-8 py-4">
                        <!-- O conte√∫do ser√° preenchido por JavaScript -->
                    </div>
                </div>

                <!-- Bot√£o de Avan√ßar -->
                <button id="affiliate-next-btn"
                    class="carousel-arrow right-0 md:-right-5 opacity-0 group-hover:opacity-100 transition-opacity">
                    &#x2192;
                </button>
            </div>
        </div>
    </div>

    <footer data-include="/components/_footer.html" class="bg-slate-800 text-slate-400 mt-16 py-8"></footer>

    <!-- Banner de Termos e Cookies -->
    <div id="terms-banner"
        class="hidden fixed bottom-0 left-0 right-0 bg-slate-900 text-white p-4 shadow-lg z-50 transform translate-y-full transition-transform duration-500 ease-in-out">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <p class="text-sm text-slate-300 text-center md:text-left">
                Usamos cookies para melhorar a sua experi√™ncia. Ao continuar a navegar, voc√™ concorda com os nossos
                <a href="/termos" target="_blank" class="font-semibold underline hover:text-emerald-400">Termos e
                    Condi√ß√µes</a> e
                <a href="/privacidade" target="_blank" class="font-semibold underline hover:text-emerald-400">Pol√≠tica
                    de Privacidade</a>.
            </p>
            <div class="flex gap-3 flex-shrink-0">
                <button id="reject-terms-btn"
                    class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Rejeitar</button>
                <button id="accept-terms-btn"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Aceitar</button>
            </div>
        </div>
    </div>

    <!-- Os scripts foram movidos para dentro do <script type="module"> para garantir a ordem de execu√ß√£o -->
    <script src="/js/components.js"></script>
    <script type="module">

        // --- CONFIGURA√á√ÉO ---
        const WEBSOCKET_URL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`;

        let SESSION_ID;
        let dbClient;
        let ws;
        let marketData; // Declarada no escopo do m√≥dulo
        let affiliateAutoScrollInterval; // Vari√°vel para controlar o auto-scroll

        const appState = {
            selectedBank: { code: 'BNA', usd_rate: 0, eur_rate: 0 },
            _listeners: [], addListener(fn) { this._listeners.push(fn); },
            updateSelectedBank(bankData) { this.selectedBank = bankData; this._listeners.forEach(fn => fn(bankData)); }
        };

        const currencyFlags = { USD: 'üá∫üá∏', EUR: 'üá™üá∫', AOA: 'üá¶üá¥', USDT: 'ü™ô' };

        // Safe gtag wrapper to prevent errors when GA hasn't loaded
        function safeGtag(...args) {
            if (typeof gtag !== 'undefined' && typeof gtag === 'function') {
                try {
                    gtag(...args);
                } catch (error) {
                    console.warn('gtag error:', error);
                }
            }
        }


        // --- FUN√á√ïES DE UTILIDADE ---
        function getOrCreateVisitorIdentity() {
            // Session ID: dura apenas enquanto a aba est√° aberta.
            let sessionId = sessionStorage.getItem('app_session_id');
            if (!sessionId) {
                sessionId = crypto.randomUUID();
                sessionStorage.setItem('app_session_id', sessionId);
            }

            // Visitor ID e Name: persistem entre visitas.
            let visitorId = localStorage.getItem('visitor_id');
            let visitorName = localStorage.getItem('visitor_name');
            let isNewVisitor = false;

            if (!visitorId) {
                isNewVisitor = true;
                visitorId = crypto.randomUUID();
                const adjectives = ['Curioso', 'R√°pido', 'Atento', 'Explorador', 'Decidido', 'Inteligente', 'Perspicaz', 'Moderno'];
                const nouns = ['Visitante', 'Navegador', 'Utilizador', 'Investidor', 'Comprador', 'Analista', 'Viajante'];
                visitorName = `${nouns[Math.floor(Math.random() * nouns.length)]} ${adjectives[Math.floor(Math.random() * adjectives.length)]}`;

                localStorage.setItem('visitor_id', visitorId);
                localStorage.setItem('visitor_name', visitorName);
            }

            return { sessionId, visitorId, visitorName, isNewVisitor };
        }

        function formatNumber(num) {
            if (typeof num !== 'number') return 'N/A';
            return num.toLocaleString('pt-AO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatCurrency(value, currency = 'AOA') {
            if (typeof value !== 'number') return 'N/A';
            return new Intl.NumberFormat('pt-AO', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 4 }).format(value);
        }

        function formatTimestamp(isoString) {
            if (!isoString) return 'Data n√£o dispon√≠vel';
            try {
                const date = new Date(isoString);
                const months = ['janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day} de ${month} de ${year}, ${hours}:${minutes}`;
            } catch (e) {
                return 'Data inv√°lida';
            }
        }

        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---
        function switchTab(tabName) {
            const [calculatorTab, marketTab] = [document.getElementById('calculator-tab'), document.getElementById('market-tab')];
            const [calculatorPanel, marketPanel] = [document.getElementById('calculator-panel'), document.getElementById('market-panel')];
            if (tabName === 'calculator') {
                marketPanel.classList.add('hidden'); calculatorPanel.classList.remove('hidden');
                marketTab.classList.replace('tab-active', 'tab-inactive'); calculatorTab.classList.replace('tab-inactive', 'tab-active');
                safeGtag('event', 'select_content', {
                    content_type: 'tab',
                    item_id: 'calculator'
                });
                logActivity('tab_switch', { tab: 'Calculadora' });
            } else {
                calculatorPanel.classList.add('hidden'); marketPanel.classList.remove('hidden');
                calculatorTab.classList.replace('tab-active', 'tab-inactive'); marketTab.classList.replace('tab-inactive', 'tab-active');
                safeGtag('event', 'select_content', {
                    content_type: 'tab',
                    item_id: 'market'
                });
                logActivity('tab_switch', { tab: 'Mercado' });
            }
        }

        function switchMarketTab(tabName) {
            const [formalTabBtn, informalTabBtn] = [document.getElementById('formal-market-tab-btn'), document.getElementById('informal-market-tab-btn')];
            const [formalPanel, informalPanel] = [document.getElementById('formal-market-panel'), document.getElementById('informal-market-panel')];
            const activeClasses = ['bg-white', 'text-[var(--theme-color)]', 'shadow-md'], inactiveClasses = ['text-gray-600'];

            formalPanel.classList.toggle('hidden', tabName !== 'formal');
            informalPanel.classList.toggle('hidden', tabName === 'formal');

            formalTabBtn.classList.add(...(tabName === 'formal' ? activeClasses : inactiveClasses));
            formalTabBtn.classList.remove(...(tabName !== 'formal' ? activeClasses : inactiveClasses));

            informalTabBtn.classList.add(...(tabName !== 'formal' ? activeClasses : inactiveClasses));
            informalTabBtn.classList.remove(...(tabName === 'formal' ? activeClasses : inactiveClasses));

            safeGtag('event', 'select_content', {
                content_type: 'market_type',
                item_id: tabName
            });
        }

        function setupEventListeners() {
            document.getElementById('market-tab').addEventListener('click', () => switchTab('market'));
            document.getElementById('calculator-tab').addEventListener('click', () => switchTab('calculator'));
            document.getElementById('formal-market-tab-btn').addEventListener('click', () => switchMarketTab('formal'));
            document.getElementById('informal-market-tab-btn').addEventListener('click', () => switchMarketTab('informal'));
        }
        // --- M√ìDULO DO MERCADO ---
        const MarketModule = (function () {
            function renderBankCards(containerId, banks) {
                const gridContainer = document.getElementById(containerId);
                if (!gridContainer || !banks || banks.length === 0) {
                    if (gridContainer) gridContainer.innerHTML = '<p class="col-span-full text-center text-slate-500 py-8">Nenhum banco dispon√≠vel de momento.</p>';
                    return;
                };

                gridContainer.innerHTML = Array(3).fill(0).map(() => `
                    <div class="p-4 rounded-xl border-l-4 border-gray-200 bg-gray-50 shadow-sm h-full">
                        <div class="skeleton h-6 w-1/4 mb-2"></div>
                        <div class="skeleton h-4 w-1/2 mb-6"></div>
                        <div class="space-y-4 mt-4">
                            <div>
                                <div class="flex justify-between items-baseline">
                                    <div class="skeleton h-5 w-1/3"></div>
                                    <div class="skeleton h-6 w-1/4"></div>
                                </div>
                                <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                            </div>
                            <div class="pt-3 border-t border-gray-200">
                                <div class="flex justify-between items-baseline">
                                    <div class="skeleton h-5 w-1/3"></div>
                                    <div class="skeleton h-6 w-1/4"></div>
                                </div>
                                <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                            </div>
                        </div>
                    </div>`).join('');

                const bna = banks.find(b => b.code === 'BNA') || banks[0];
                if (bna) {
                    appState.updateSelectedBank({ code: bna.code, usd_rate: bna.usd_rate, eur_rate: bna.eur_rate });
                }

                const displayBanks = banks.filter(b => b.code !== 'BNA' && b.code !== 'BINANCE').sort((a, b) => (a.usd_rate || Infinity) - (b.usd_rate || Infinity));

                gridContainer.innerHTML = displayBanks.map(bank => {
                    const themeCode = CalculatorModule.getThemeCode(bank.code.toLowerCase());
                    const usd_equivalence = bank.usd_rate ? formatNumber(100 * bank.usd_rate) : 'N/A';
                    const eur_equivalence = bank.eur_rate ? formatNumber(100 * bank.eur_rate) : 'N/A';
                    return `
                        <div class="p-4 rounded-xl border-l-4 border-theme-${themeCode} bg-theme-${themeCode}-faded shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between h-full fade-in">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${bank.code}</p><p class="text-xs text-gray-600">${bank.name}</p>
                                <div class="space-y-4 mt-4">
                                    <div>
                                        <div class="flex justify-between items-baseline"><span class="text-sm font-semibold text-gray-600">${currencyFlags.USD} USD/AOA</span><span class="text-lg font-bold text-theme-${themeCode} font-mono">${formatNumber(bank.usd_rate)}</span></div>
                                        <p class="text-xs text-gray-600 text-right">100 USD ‚âà ${usd_equivalence} AOA</p>
                                    </div>
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="flex justify-between items-baseline"><span class="text-sm font-semibold text-gray-600">${currencyFlags.EUR} EUR/AOA</span><span class="text-lg font-bold text-theme-${themeCode} font-mono">${formatNumber(bank.eur_rate)}</span></div>
                                        <p class="text-xs text-gray-600 text-right">100 EUR ‚âà ${eur_equivalence} AOA</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }).join('');

                // Add Binance card if it exists
                const binance = banks.find(b => b.code === 'BINANCE');
                if (binance) {
                    // Get USDT rates from exchange_rates
                    const usdtAoa = binance.exchange_rates?.find(r => r.currency_pair === 'USDT/AOA')?.sell_rate;
                    const usdtUsd = binance.exchange_rates?.find(r => r.currency_pair === 'USDT/USD')?.sell_rate;
                    const usdtEur = binance.exchange_rates?.find(r => r.currency_pair === 'USDT/EUR')?.sell_rate;

                    if (usdtAoa || usdtUsd || usdtEur) {
                        gridContainer.innerHTML += `
                        <div class="p-4 rounded-xl border-l-4 border-green-500 bg-gradient-to-br from-green-50 to-emerald-50 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between h-full fade-in">
                            <div>
                                <p class="font-bold text-lg text-gray-800">Binance</p>
                                <p class="text-xs text-gray-600 mb-4">USDT</p>
                                <div class="space-y-3">
                                    ${usdtAoa ? `
                                    <div>
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm font-semibold text-gray-600">üá¶üá¥ USDT/AOA</span>
                                            <span class="text-lg font-bold text-green-600 font-mono">${formatNumber(usdtAoa)}</span>
                                        </div>
                                        <p class="text-xs text-gray-600 text-right">100 USDT ‚âà ${formatNumber(100 * usdtAoa)} AOA</p>
                                    </div>
                                    ` : ''}
                                    ${usdtUsd ? `
                                    <div class="pt-3 border-t border-green-200">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm font-semibold text-gray-600">üá∫üá∏ USDT/USD</span>
                                            <span class="text-lg font-bold text-green-600 font-mono">${usdtUsd.toFixed(4)}</span>
                                        </div>
                                        <p class="text-xs text-gray-600 text-right">100 USDT ‚âà ${(100 * usdtUsd).toFixed(2)} USD</p>
                                    </div>
                                    ` : ''}
                                    ${usdtEur ? `
                                    <div class="pt-3 border-t border-green-200">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-sm font-semibold text-gray-600">üá™üá∫ USDT/EUR</span>
                                            <span class="text-lg font-bold text-green-600 font-mono">${usdtEur.toFixed(4)}</span>
                                        </div>
                                        <p class="text-xs text-gray-600 text-right">100 USDT ‚âà ${(100 * usdtEur).toFixed(2)} EUR</p>
                                    </div>
                                    ` : ''}
                                </div>
                                <p class="text-xs text-gray-500 italic mt-4">Fonte: Binance + Coinbase</p>
                            </div>
                        </div>`;
                    }
                }
            }

            function renderInformalMarket(data) { // data is informal_rates_by_province
                if (!data || Object.keys(data).length === 0) {
                    document.getElementById('kinguila-grid').innerHTML = '<p class="text-center text-slate-500 py-8">Nenhuma taxa dispon√≠vel.</p>';
                    document.getElementById('casa-cambio-grid').innerHTML = '<p class="text-center text-slate-500 py-8">Nenhuma taxa dispon√≠vel.</p>';
                    return;
                }

                // Procurar pelos providers KINGUILA e CASA_CAMBIO nos dados
                // Os dados v√™m como: { "KINGUILA": [...rates], "CASA_CAMBIO": [...rates] }
                const kinguilaRates = data['KINGUILA'] || data['Kinguila'] || null;
                const casaCambioRates = data['CASA_CAMBIO'] || data['Casa de C√¢mbio'] || null;

                // Renderizar ambas as sec√ß√µes
                renderInformalSection('kinguila-grid', kinguilaRates, 'orange');
                renderInformalSection('casa-cambio-grid', casaCambioRates, 'blue');

                // Atualizar o conversor informal com as taxas de Kinguila (prioridade) ou Casa de C√¢mbio
                window.informalConverterRates = kinguilaRates || casaCambioRates;
                window.updateInformalConverter?.();
            }

            function renderInformalSection(containerId, rates, colorTheme) {
                const gridContainer = document.getElementById(containerId);
                if (!gridContainer) return;

                const requiredPairs = ['USD/AOA', 'EUR/AOA', 'USDT/AOA'];
                const borderColor = colorTheme === 'orange' ? 'border-orange-200' : 'border-blue-200';

                if (!rates || rates.length === 0) {
                    gridContainer.innerHTML = `<p class="text-center text-slate-500 py-4">Nenhuma taxa dispon√≠vel.</p>`;
                    return;
                }

                gridContainer.innerHTML = requiredPairs.map(pair => {
                    const item = rates.find(p => p.pair === pair);
                    const [from, to] = pair.split('/');
                    const fromFlag = currencyFlags[from] || 'üè≥Ô∏è';
                    const toFlag = currencyFlags[to] || 'üè≥Ô∏è';

                    if (item) {
                        const sellRate = item.sell_rate || item.rate;
                        const buyRate = item.buy_rate || (sellRate * 0.98);

                        return `
                            <div class="bg-white/80 border ${borderColor} p-4 rounded-xl hover:shadow-lg hover:-translate-y-1 transition-all duration-300 fade-in">
                                <p class="text-sm text-gray-600 font-bold mb-2">${fromFlag} ${from} / ${toFlag} ${to}</p>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs text-gray-500">Compra:</span>
                                        <span class="text-lg font-bold text-gray-800 font-mono">${formatNumber(buyRate)}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs text-gray-500">Venda:</span>
                                        <span class="text-lg font-bold text-emerald-600 font-mono">${formatNumber(sellRate)}</span>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t ${borderColor}">
                                    <p class="text-xs text-gray-600">100 ${from} ‚âà ${formatNumber(100 * sellRate)} ${to}</p>
                                </div>
                            </div>`;
                    }
                    return `
                        <div class="bg-white/40 border ${borderColor} p-4 rounded-xl opacity-60 fade-in">
                            <p class="text-sm text-gray-600 font-bold mb-2">${fromFlag} ${from} / ${toFlag} ${to}</p>
                            <p class="text-2xl font-bold text-gray-400 mt-1">N/A</p>
                            <div class="mt-3 pt-3 border-t ${borderColor}">
                                <p class="text-xs text-gray-400">Dados indispon√≠veis</p>
                            </div>
                        </div>`;
                }).join('');
            }

            function setupQuickConverter() {
                const amountInput = document.getElementById('quick-converter-amount');
                const switchBtn = document.getElementById('quick-converter-switch');
                const fromSelect = document.getElementById('quick-converter-from');
                const toSelect = document.getElementById('quick-converter-to');
                const resultDisplay = document.getElementById('quick-converter-result');

                function updateToOptions() {
                    const fromValue = fromSelect.value;
                    const toValue = toSelect.value;

                    Array.from(toSelect.options).forEach(option => {
                        option.disabled = (option.value === fromValue);
                    });

                    if (fromValue === toValue) toSelect.value = Array.from(toSelect.options).find(opt => !opt.disabled).value;
                }

                appState.addListener((bankData) => {
                    document.getElementById('quick-converter-bank-name').textContent = bankData.code;
                    calculate();
                });

                const calculate = () => {
                    const amountStr = amountInput.value.replace(/\./g, '').replace(',', '.');
                    const amount = parseFloat(amountStr);
                    if (isNaN(amount) || amount === 0) {
                        resultDisplay.textContent = '';
                        return;
                    }

                    const from = fromSelect.value, to = toSelect.value;
                    const rates = appState.selectedBank;
                    let rate = 0;
                    if (from === 'USD' && to === 'AOA') rate = rates.usd_rate;
                    else if (from === 'AOA' && to === 'USD') rate = 1 / rates.usd_rate;
                    else if (from === 'EUR' && to === 'AOA') rate = rates.eur_rate;
                    else if (from === 'AOA' && to === 'EUR') rate = 1 / rates.eur_rate;
                    else if (from === 'USD' && to === 'EUR') rate = rates.usd_rate / rates.eur_rate;
                    else if (from === 'EUR' && to === 'USD') rate = rates.eur_rate / rates.usd_rate;
                    else if (from === to) rate = 1;

                    resultDisplay.textContent = (rate && isFinite(rate))
                        ? `‚âà ${formatNumber(amount * rate)} ${to}`
                        : 'Taxa indispon√≠vel';
                };

                // --- L√ìGICA DE FORMATA√á√ÉO DO CAMPO DE VALOR (similar √† calculadora) ---
                amountInput.addEventListener('input', (e) => {
                    // 1. Limpa tudo o que n√£o for n√∫mero
                    let rawValue = e.target.value.replace(/[^0-9]/g, '');

                    if (rawValue === '') {
                        e.target.value = '';
                        calculate(); // Recalcula para limpar o resultado
                        return;
                    }

                    // 2. Converte para um n√∫mero para formata√ß√£o
                    const numberValue = parseFloat(rawValue) / 100;

                    // 3. Formata para exibi√ß√£o no padr√£o portugu√™s
                    e.target.value = new Intl.NumberFormat('pt-PT', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(numberValue);

                    calculate(); // Chama o c√°lculo ap√≥s a formata√ß√£o
                });
                toSelect.addEventListener('input', calculate);
                fromSelect.addEventListener('input', () => {
                    updateToOptions();
                    calculate();
                });
                switchBtn.addEventListener('click', () => {
                    // Adiciona classes para a anima√ß√£o de sa√≠da
                    fromSelect.classList.add('slide-out-left');
                    toSelect.classList.add('slide-out-right');

                    // Espera a anima√ß√£o terminar para trocar os valores e remover as classes
                    setTimeout(() => {
                        [fromSelect.value, toSelect.value] = [toSelect.value, fromSelect.value];

                        // Remove as classes para que os elementos voltem ao estado normal (vis√≠vel)
                        fromSelect.classList.remove('slide-out-left');
                        toSelect.classList.remove('slide-out-right');

                        updateToOptions();
                        calculate();
                    }, 200); // Dura√ß√£o da anima√ß√£o em ms
                });
                updateToOptions(); // Chamada inicial para garantir o estado correto
            }

            function setupInformalQuickConverter() {
                const amountInput = document.getElementById('informal-converter-amount');
                const switchBtn = document.getElementById('informal-converter-switch');
                const fromSelect = document.getElementById('informal-converter-from');
                const toSelect = document.getElementById('informal-converter-to');
                const resultDisplay = document.getElementById('informal-converter-result');
                const provinceNameDisplay = document.getElementById('informal-converter-province-name');

                function updateToOptions() {
                    const fromValue = fromSelect.value;
                    Array.from(toSelect.options).forEach(option => {
                        option.disabled = (option.value === fromValue);
                    });
                    if (fromSelect.value === toSelect.value) {
                        toSelect.value = Array.from(toSelect.options).find(opt => !opt.disabled).value;
                    }
                }

                const calculate = () => {
                    const activeTab = document.querySelector('.province-tab-active');
                    if (!activeTab) return;

                    const province = activeTab.dataset.province;
                    provinceNameDisplay.textContent = `(${province})`;

                    const amountStr = amountInput.value.replace(/\./g, '').replace(',', '.');
                    const amount = parseFloat(amountStr);
                    if (isNaN(amount) || amount === 0) {
                        resultDisplay.textContent = '';
                        return;
                    }

                    const from = fromSelect.value, to = toSelect.value;
                    const provinceRates = marketData.informal_rates_by_province[province] || [];

                    let rate = 0;
                    if (from === to) {
                        rate = 1;
                    } else if (to === 'AOA') { // Convers√£o para AOA
                        const pair = `${from}/AOA`;
                        const rateData = provinceRates.find(r => r.pair === pair);
                        rate = rateData ? rateData.rate : 0;
                    } else if (from === 'AOA') { // Convers√£o de AOA
                        const pair = `${to}/AOA`;
                        const rateData = provinceRates.find(r => r.pair === pair);
                        rate = rateData ? 1 / rateData.rate : 0;
                    } else { // Convers√£o entre moedas estrangeiras (ex: USD -> EUR)
                        const fromToAoaPair = `${from}/AOA`;
                        const toToAoaPair = `${to}/AOA`;
                        const fromRateData = provinceRates.find(r => r.pair === fromToAoaPair);
                        const toRateData = provinceRates.find(r => r.pair === toToAoaPair);
                        if (fromRateData && toRateData && toRateData.rate > 0) {
                            rate = fromRateData.rate / toRateData.rate;
                        }
                    }

                    resultDisplay.textContent = (rate && isFinite(rate))
                        ? `‚âà ${formatNumber(amount * rate)} ${to}`
                        : 'Taxa indispon√≠vel';
                };

                // Expor a fun√ß√£o de c√°lculo para ser chamada externamente
                window.updateInformalConverter = calculate;

                amountInput.addEventListener('input', (e) => {
                    let rawValue = e.target.value.replace(/[^0-9]/g, '');
                    if (rawValue === '') {
                        e.target.value = '';
                        calculate();
                        return;
                    }
                    const numberValue = parseFloat(rawValue) / 100;
                    e.target.value = new Intl.NumberFormat('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(numberValue);
                    calculate();
                });

                [fromSelect, toSelect].forEach(el => el.addEventListener('input', () => {
                    updateToOptions();
                    calculate();
                }));

                switchBtn.addEventListener('click', () => {
                    fromSelect.classList.add('slide-out-left');
                    toSelect.classList.add('slide-out-right');
                    setTimeout(() => {
                        [fromSelect.value, toSelect.value] = [toSelect.value, fromSelect.value];
                        fromSelect.classList.remove('slide-out-left');
                        toSelect.classList.remove('slide-out-right');
                        updateToOptions();
                        calculate();
                    }, 200);
                });
                updateToOptions();
            }

            function init(data) {
                renderBankCards('formal-market-grid', data.formal_rates || []);
                renderInformalMarket(data.informal_rates_by_province || {});
                setupQuickConverter();
                setupInformalQuickConverter();

                // Update timestamps
                updateTimestamps(data);
            }

            async function updateTimestamps(data) {
                try {
                    // Get most recent formal market timestamp from database
                    const { data: formalUpdate, error: formalError } = await dbClient
                        .from('exchange_rates')
                        .select('updated_at')
                        .in('provider_id', data.formal_rates?.map(b => b.id).filter(Boolean) || [])
                        .order('updated_at', { ascending: false })
                        .limit(1)
                        .single();

                    if (!formalError && formalUpdate) {
                        const formalTimestampEl = document.getElementById('formal-market-timestamp');
                        if (formalTimestampEl) {
                            const spanEl = formalTimestampEl.querySelector('span');
                            if (spanEl) {
                                spanEl.textContent = `√öltima atualiza√ß√£o: ${formatTimestamp(formalUpdate.updated_at)}`;
                            }
                        }
                    }

                    // Get most recent informal market timestamp
                    const informalProviderIds = Object.values(data.informal_rates_by_province || {})
                        .flatMap(provider => provider.rates || [])
                        .map(rate => rate.provider_id)
                        .filter(Boolean);

                    if (informalProviderIds.length > 0) {
                        const { data: informalUpdate, error: informalError } = await dbClient
                            .from('exchange_rates')
                            .select('updated_at')
                            .in('provider_id', informalProviderIds)
                            .order('updated_at', { ascending: false })
                            .limit(1)
                            .single();

                        if (!informalError && informalUpdate) {
                            const informalTimestampEl = document.getElementById('informal-market-timestamp');
                            if (informalTimestampEl) {
                                const spanEl = informalTimestampEl.querySelector('span');
                                if (spanEl) {
                                    spanEl.textContent = `√öltima atualiza√ß√£o: ${formatTimestamp(informalUpdate.updated_at)}`;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating timestamps:', error);
                }
            }

            return { init };
        })();

        // --- M√ìDULO DA CALCULADORA ---
        const CalculatorModule = (function () {
            const container = document.getElementById('calculator-card-container'); // eslint-disable-line
            let purchasePriceInput, bankSelectorBtn, bankOptionsPanel, selectedBankCode, bankExchangeRateInput, bankFeeMarginInput, bankFeeFinalInput, calculateBtn, calculatorCard, dropdownArrow, baseFeePercent;
            const themes = {
                bai: { card: 'theme-bai', color: '#0194b3' },     // BAI - Cyan blue (unchanged)
                bfa: { card: 'theme-bfa', color: '#FF8C00' },     // BFA - Vibrant orange
                bic: { card: 'theme-bic', color: '#E30613' },     // BIC - Brand red
                bpc: { card: 'theme-bpc', color: '#0066B3' },     // BPC - Blue
                bci: { card: 'theme-bci', color: '#00563F' },     // BCI - Dark green
                yetu: { card: 'theme-yetu', color: '#FFB81C' },   // YETU - Bright gold
                // Fallback para novos bancos: usar o tema do BPC
                default: { card: 'theme-bpc', color: '#0066B3' }
            };
            let priceMask; // Vari√°vel para guardar a inst√¢ncia do IMask

            function getThemeCode(bankCode) {
                const code = bankCode.toLowerCase();
                return themes[code] ? code : 'default';
            }

            function render(banks) {
                container.innerHTML = `
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-white mb-3">Calculadora de C√¢mbio</h2>
                            <p class="text-sm md:text-base text-gray-200">Estime o custo da sua compra em Angola</p>
                        </div>
                        <div class="mb-4">
                            <label for="calculator-currency-selector" class="block text-base font-semibold text-gray-200 mb-2">Moeda</label>
                            <select id="calculator-currency-selector" class="w-full bg-white/90 text-gray-800 font-bold p-4 rounded-2xl custom-select focus:outline-none focus:ring-4 focus:ring-green-400 transition">
                                <option value="USD">üá∫üá∏ D√≥lar Americano (USD)</option>
                                <option value="EUR">üá™üá∫ Euro (EUR)</option>
                                <option value="AOA">üá¶üá¥ Kwanza Angolano (AOA)</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="purchasePrice" class="block text-base font-semibold text-gray-200 mb-2">Valor da Compra</label>
                            <div class="flex items-center rounded-2xl bg-white/90 ring-4 ring-transparent focus-within:ring-green-400 transition">
                                <input type="text" inputmode="decimal" id="purchasePrice" class="flex-1 w-full bg-transparent text-lg p-4 text-gray-900 placeholder-gray-500 focus:outline-none calc-input" placeholder="100,00" />
                                <div class="relative" id="bank-selector-wrapper">
                                    <input type="hidden" id="bankExchangeRate" /><input type="hidden" id="bankFeeMargin" /><input type="hidden" id="bankFeeFinal" />
                                    <button type="button" id="bankSelectorBtn" class="flex items-center justify-between w-full text-left text-gray-800 text-base p-4 border-l border-gray-400/50">
                                        <span id="selectedBankCode" class="font-bold"></span>
                                        <svg class="w-5 h-5 text-gray-600 transform transition-transform" id="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div id="bankOptionsPanel" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-20 border border-gray-200">${populateBankSelector(banks)}</div>
                                </div>
                            </div>
                        </div>
                        <button id="calculateBtn" class="w-full text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 text-lg transform hover:scale-105 focus:outline-none focus:ring-4">Calcular Custo</button>
                        <div id="result" class="mt-8 border-t border-white/20 pt-6 space-y-4 opacity-0 transition-opacity duration-500">
                            <div><p class="text-base font-semibold text-gray-200">Valor a carregar (AOA):</p><p id="directConversionValue" class="text-2xl font-bold text-white mt-1">0,00</p></div>
                            <div class="bg-white/15 backdrop-blur-sm p-5 rounded-2xl border border-white/10"><p class="text-base font-semibold text-white">Valor total a ser descontado (AOA)</p><p id="totalCost" class="text-4xl font-bold text-white mt-1">0,00</p></div>
                        </div>
                    </div>`;

                calculatorCard = container;
                purchasePriceInput = document.getElementById('purchasePrice');
                bankSelectorBtn = document.getElementById('bankSelectorBtn'); // eslint-disable-line
                bankOptionsPanel = document.getElementById('bankOptionsPanel');
                selectedBankCode = document.getElementById('selectedBankCode');
                dropdownArrow = document.getElementById('dropdown-arrow');
                bankExchangeRateInput = document.getElementById('bankExchangeRate');
                bankFeeMarginInput = document.getElementById('bankFeeMargin');
                bankFeeFinalInput = document.getElementById('bankFeeFinal');
                calculateBtn = document.getElementById('calculateBtn');
                baseFeePercent = marketData?.calculator_base_fee_percent || 12;
            }

            function toggleDropdown() { bankOptionsPanel.classList.toggle('hidden'); dropdownArrow.classList.toggle('rotate-180'); }

            function populateBankSelector(banks) {
                if (!banks || banks.length === 0) return '<div class="px-4 py-3 text-sm text-gray-600">Nenhum banco dispon√≠vel.</div>';
                return banks.sort((a, b) => a.code.localeCompare(b.code)).map(bank =>
                    `<div class="bank-option px-4 py-3 hover:bg-gray-100 cursor-pointer text-gray-800 text-sm" data-code="${bank.code}" data-usd-rate="${bank.usd_rate}" data-eur-rate="${bank.eur_rate}" data-fee-margin="${bank.fee_margin}" data-fee-final="${bank.fee_final}"><span class="font-bold">${bank.code}</span></div>`
                ).join('');
            }

            function selectBank(bankData) {
                selectedBankCode.textContent = bankData.code;
                bankExchangeRateInput.value = bankData.usdRate || 0; // Mant√©m USD como padr√£o
                bankFeeMarginInput.value = bankData.feeMargin || 0;
                bankFeeFinalInput.value = bankData.feeFinal || 0;

                const themeCode = getThemeCode(bankData.code);
                const theme = themes[themeCode];
                calculatorCard.className = `w-full max-w-xl mx-auto calculator-card min-h-[400px] ${theme ? theme.card : ''}`;
                document.documentElement.style.setProperty('--theme-color', theme.color);
            }

            function handleCalculation() {
                // Usamos o `unmaskedValue` do IMask para obter o n√∫mero como string
                const currencySelector = document.getElementById('calculator-currency-selector');
                const selectedCurrency = currencySelector.value;
                const bankOption = document.querySelector(`.bank-option[data-code="${selectedBankCode.textContent}"]`);

                let rate = 1;
                if (selectedCurrency === 'USD') {
                    rate = parseFloat(bankOption.dataset.usdRate);

                } else if (selectedCurrency === 'EUR') {
                    rate = parseFloat(bankOption.dataset.eurRate);
                }

                // Obt√©m o valor num√©rico diretamente do atributo do input
                const priceStr = purchasePriceInput.dataset.rawValue || '0';
                const [price, margin, finalFee] = [priceStr, bankFeeMarginInput.value, bankFeeFinalInput.value].map(parseFloat);
                const resultPanel = document.getElementById('result');
                const directConversionLabel = document.getElementById('directConversionValue');

                if (![price, rate].every(v => !isNaN(v) && v > 0)) {
                    resultPanel.classList.add('opacity-0');
                    return;
                }
                //conversao directa de kwanza para moeda estrangeira
                const directConversion = price * rate;
                const resultLabel1 = resultPanel.querySelector('div:first-child > p.text-base');
                const resultLabel2 = resultPanel.querySelector('div.bg-white\\/15 > p.text-base');

                // S√≥ aplica taxas se a convers√£o for de moeda estrangeira para AOA
                if (selectedCurrency !== 'AOA') {
                    let totalCost = directConversion;
                    let valueWithBaseFee = directConversion;
                    // 1. Adiciona a comiss√£o base (ex: 12%) ao valor convertido
                    const feeMultiplier = 1 + (baseFeePercent / 100);
                    valueWithBaseFee = directConversion * feeMultiplier;

                    // 2. Calcula as comiss√µes sobre o novo valor base
                    const marginValue = valueWithBaseFee * (margin / 100 || 0);
                    const finalFeeValue = valueWithBaseFee * (finalFee / 100 || 0);
                    totalCost = valueWithBaseFee + marginValue + finalFeeValue;
                    resultLabel1.textContent = 'Valor a carregar (AOA):';
                    resultLabel2.textContent = 'Valor total a ser descontado (AOA)';
                    if (directConversionLabel) directConversionLabel.textContent = formatCurrency(valueWithBaseFee, 'AOA');
                    document.getElementById('totalCost').textContent = formatCurrency(totalCost, 'AOA');
                } else {
                    // Para convers√£o AOA -> Estrangeiro, subtrai a comiss√£o antes de converter
                    const priceAfterFee = price * (1 - (baseFeePercent / 100));
                    const usdRate = parseFloat(bankOption.dataset.usdRate);
                    const eurRate = parseFloat(bankOption.dataset.eurRate);
                    resultLabel1.textContent = 'Valor em D√≥lar (USD):';
                    resultLabel2.textContent = 'Valor em Euro (EUR):';
                    if (directConversionLabel) directConversionLabel.textContent = formatCurrency(usdRate > 0 ? priceAfterFee / usdRate : 0, 'USD');
                    document.getElementById('totalCost').textContent = formatCurrency(eurRate > 0 ? priceAfterFee / eurRate : 0, 'EUR');
                }
                resultPanel.classList.remove('opacity-0');

                gtag('event', 'calculate_cost', {
                    'event_category': 'engagement',
                    'event_label': selectedBankCode.textContent,
                    'value': price
                });
            }

            function init(banks) {
                if (!banks || banks.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-white"><h3 class="font-bold text-lg">Calculadora Indispon√≠vel</h3><p>N√£o foi poss√≠vel carregar os dados dos bancos.</p></div>`;
                    return;
                }
                render(banks);

                const firstBank = banks.find(b => b.code === 'BAI') || banks[0];
                selectBank({ code: firstBank.code, usdRate: firstBank.usd_rate, eurRate: firstBank.eur_rate, feeMargin: firstBank.fee_margin, feeFinal: firstBank.fee_final });

                bankSelectorBtn.addEventListener('click', toggleDropdown);
                calculateBtn.addEventListener('click', handleCalculation);

                // Adiciona listener para o seletor de moeda
                const currencySelector = document.getElementById('calculator-currency-selector');
                currencySelector.addEventListener('change', () => {
                    // Recalcula sempre que a moeda for alterada
                    handleCalculation();
                });

                // --- NOVA L√ìGICA DE FORMATA√á√ÉO DO CAMPO DE VALOR ---
                purchasePriceInput.addEventListener('input', (e) => {
                    // 1. Limpa tudo o que n√£o for n√∫mero
                    let rawValue = e.target.value.replace(/[^0-9]/g, '');

                    // Se estiver vazio, define como '0'
                    if (rawValue === '') {
                        e.target.value = '';
                        e.target.dataset.rawValue = '0';
                        return;
                    }

                    // 2. Converte para um n√∫mero, dividindo por 100 para ter 2 casas decimais
                    const numberValue = parseFloat(rawValue) / 100;
                    e.target.dataset.rawValue = numberValue.toFixed(2); // Guarda o valor real (ex: 123.45)

                    // 3. Formata o n√∫mero para exibi√ß√£o no padr√£o portugu√™s (ex: 1.234,56)
                    const formattedValue = new Intl.NumberFormat('pt-PT', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(numberValue);

                    // 4. Atualiza o valor vis√≠vel no campo
                    e.target.value = formattedValue;
                });

                // Garante que o c√°lculo √© feito ao pressionar Enter no campo
                purchasePriceInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        calculateBtn.click();
                    }
                });

                bankOptionsPanel.addEventListener('click', (e) => {
                    if (e.target.closest('.bank-option')) {
                        selectBank(e.target.closest('.bank-option').dataset); // eslint-disable-line
                        toggleDropdown();
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!document.getElementById('bank-selector-wrapper').contains(e.target)) {
                        bankOptionsPanel.classList.add('hidden'); dropdownArrow.classList.remove('rotate-180');
                    }
                });
            }
            return { init, getThemeCode };
        })();

        // --- M√ìDULO WEBSOCKET ---
        const WebSocketModule = (function () {
            function connect() {
                try {
                    ws = new WebSocket(WEBSOCKET_URL);
                    ws.onopen = () => console.log('WebSocket conectado.');
                    ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'rates_updated') {
                            console.log('Recebida notifica√ß√£o de atualiza√ß√£o de taxas. A recarregar dados...');
                            showLiveUpdateToast();
                            reloadMarketData();
                        }
                    };
                    ws.onclose = () => setTimeout(connect, 5000);
                    ws.onerror = (err) => console.error('Erro no WebSocket:', err);
                } catch (e) {
                    console.error("Falha ao conectar ao WebSocket:", e)
                }
            }
            function send(data) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(data));
                }
            }
            return { connect, send };
        })();

        function showLiveUpdateToast() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-5 right-5 bg-blue-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-out z-50';
            toast.innerHTML = `<p>As taxas foram atualizadas!</p>`;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.remove('translate-x-[120%]'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- FUN√á√ÉO PRINCIPAL ---
        async function main() {
            setupEventListeners();
            const identity = getOrCreateVisitorIdentity();
            SESSION_ID = identity.sessionId; // Mant√©m o SESSION_ID para compatibilidade, se necess√°rio

            switchTab('market');
            switchMarketTab('formal');

            WebSocketModule.connect();

            if (identity.isNewVisitor) logActivity('first_visit');

            // Garante que os dados do mercado (taxas) s√£o carregados primeiro
            await reloadMarketData();

            // Agora carrega o resto dos dados que dependem das taxas
            loadAffiliateLinks();
            loadSupporters();
            loadFooterInfo();


            logActivity('page_view');
        }

        async function reloadMarketData() {
            try {
                const { data, error } = await dbClient.rpc('get_market_data');
                if (error) throw error;
                marketData = data;
                if (!marketData || (!marketData.formal_rates && !marketData.informal_rates_by_province)) {
                    throw new Error("A fun√ß√£o RPC 'get_market_data' n√£o retornou dados v√°lidos.");
                }
            } catch (rpcError) {
                console.warn("RPC 'get_market_data' falhou. Tentando fallback.", rpcError.message);
                marketData = await fallbackFetchMarketData();
            }

            if (!marketData) {
                console.error("N√£o foi poss√≠vel obter os dados do mercado.");
                document.getElementById('myTabContent').innerHTML = `<div class="text-center p-8 bg-red-50 text-red-700 rounded-2xl"><h3 class="font-bold text-lg">Erro ao Carregar Dados</h3><p>N√£o foi poss√≠vel comunicar com a base de dados. Tente mais tarde.</p></div>`;
                return;
            }

            document.querySelectorAll('.loader-container').forEach(el => el.style.display = 'none');
            MarketModule.init(marketData);
            const banksForCalculator = marketData.formal_rates?.filter(bank => bank.code !== 'BNA') || [];
            CalculatorModule.init(banksForCalculator);
        }

        async function fallbackFetchMarketData() {
            try {
                const { data: providers, error } = await dbClient.from('rate_providers').select('*, exchange_rates(*)').eq('is_active', true);
                if (error) throw error;

                return {
                    formal_rates: providers.filter(p => p.type === 'FORMAL').map(p => ({
                        code: p.code, name: p.name,
                        usd_rate: p.exchange_rates.find(r => r.currency_pair === 'USD/AOA')?.sell_rate || null,
                        eur_rate: p.exchange_rates.find(r => r.currency_pair === 'EUR/AOA')?.sell_rate || null,
                        fee_margin: p.fee_margin, fee_final: p.fee_final
                    })),
                    informal_rates_by_province: providers.filter(p => p.type === 'INFORMAL' && p.exchange_rates.length > 0)
                        .reduce((acc, p) => {
                            acc[p.name] = p.exchange_rates.map(rate => ({ pair: rate.currency_pair, rate: rate.sell_rate, provider_id: p.id }));
                            return acc;
                        }, {})
                };
            } catch (fallbackError) {
                console.error("Falha no fallback:", fallbackError);
                return null;
            }
        }

        async function loadAffiliateLinks() {
            const track = document.getElementById('affiliate-track');
            const container = document.getElementById('affiliate-links-container'); // Container com scroll
            const { data, error } = await dbClient // A query √© feita aqui

            track.innerHTML = Array(4).fill(0).map(() => `
                <div class="block bg-slate-700 rounded-lg overflow-hidden shadow-lg w-48 md:w-56 flex-shrink-0">
                    <div class="skeleton-dark h-32 w-full"></div>
                    <div class="p-3">
                        <div class="skeleton-dark h-5 w-full mb-2"></div>
                        <div class="skeleton-dark h-6 w-3/4"></div>
                    </div>
                </div>
            `).join('');


            const { data: affiliateData, error: affiliateError } = await dbClient
                .from('affiliate_links')
                .select('*')
                .eq('is_active', true)
                .order('created_at', { ascending: false })
                .limit(12);

            const bnaBank = marketData?.formal_rates?.find(r => r.code?.toUpperCase() === 'BNA');
            let bnaRate = bnaBank?.usd_rate;

            // Log para depura√ß√£o: Verifique estes valores no console do navegador
            console.log('DEBUG: marketData in loadAffiliateLinks:', marketData);
            console.log('DEBUG: BNA Bank found:', bnaBank);
            console.log('DEBUG: BNA USD Rate:', bnaRate);

            // --- MELHORIA: Fallback para buscar a taxa do BNA se n√£o for encontrada ---
            // Se a taxa do BNA n√£o veio nos dados do mercado, tenta busc√°-la diretamente.
            if (!bnaRate || bnaRate <= 0) {
                console.warn("Taxa BNA n√£o encontrada nos dados do mercado. Tentando fallback...");
                const { data: bnaData, error: bnaError } = await dbClient.from('exchange_rates').select('sell_rate').eq('provider_id', 1).eq('currency_pair', 'USD/AOA').single(); // Assumindo que o ID do BNA √© 1
                if (bnaError) console.error("Erro no fallback para buscar taxa BNA:", bnaError);

                if (bnaData?.sell_rate > 0) bnaRate = bnaData.sell_rate;
            }

            const wrapper = document.getElementById('affiliate-links-wrapper'); // 'track' is already declared above


            if (!marketData || !marketData.formal_rates) {
                console.error('Erro: marketData ou formal_rates n√£o est√£o dispon√≠veis para calcular os pre√ßos dos afiliados. Certifique-se de que os dados do mercado foram carregados corretamente.');
                wrapper.closest('.bg-slate-800').classList.add('hidden'); // Esconde a sec√ß√£o se os dados essenciais estiverem em falta
                return;
            }
            if (affiliateError || !affiliateData || affiliateData.length === 0) {
                if (affiliateError) console.error('Erro ao carregar links de afiliados:', affiliateError);
                wrapper.closest('.bg-slate-800').classList.add('hidden');
                return;
            }

            const linksHTML = affiliateData.map(link => { // eslint-disable-line
                const totalUSD = (link.price || 0) + (link.shipping_cost_usd || 0);
                let priceDisplay = 'N/A'; // Valor padr√£o caso a taxa n√£o esteja dispon√≠vel

                if (typeof bnaRate === 'number' && bnaRate > 0) {
                    const totalAOA = totalUSD * bnaRate; // O c√°lculo j√° est√° correto aqui
                    priceDisplay = formatCurrency(totalAOA, 'AOA');
                } else {
                    console.warn(`Taxa BNA n√£o dispon√≠vel ou inv√°lida para o link de afiliado "${link.title}". bnaRate: ${bnaRate}. Exibindo N/A.`);
                }

                return `<a href="details.html?id=${link.id}" 
                       class="affiliate-link-item group block bg-slate-700 rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-shadow duration-300 w-48 md:w-56 flex-shrink-0"
                       data-affiliate-id="${link.id}" 
                       data-product-title="${link.title}">
                        <img src="${link.image_url || '/assets/error-state.svg'}" alt="Imagem de ${link.title}" class="w-full h-32 object-cover group-hover:opacity-80 transition-opacity bg-slate-600" loading="lazy" decoding="async" width="224" height="128" onerror="this.onerror=null; this.src='/assets/error-state.svg'; this.classList.add('p-4');">
                        <div class="p-3">
                            <h3 class="text-sm font-semibold text-white truncate">${link.title}</h3>
                            <p class="text-base font-bold text-emerald-400 mt-1 text-right">
                                ${priceDisplay}
                            </p>
                        </div>
                    </a>`;
            }).join('');

            // Verifica se h√° dados v√°lidos antes de renderizar
            if (!linksHTML || linksHTML.trim() === '') {
                wrapper.closest('.bg-slate-800').classList.add('hidden');
                return;
            }

            // Duplica o conte√∫do para o efeito de loop infinito
            track.innerHTML = linksHTML + linksHTML;

            // Adiciona event listeners para os links de afiliados
            track.querySelectorAll('.affiliate-link-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Previne a navega√ß√£o imediata
                    const linkId = link.href.split('id=')[1];
                    const productTitle = link.querySelector('h3').textContent;
                    const destinationUrl = link.href;

                    console.log(`[WebSocket] Clique de afiliado. Enviando dados...`, { link_id: linkId, product_title: productTitle });
                    logActivity('affiliate_click', { link_id: linkId, product_title: productTitle });

                    gtag('event', 'select_item', {
                        item_list_name: "Affiliate Products",
                        items: [{ item_id: linkId, item_name: productTitle }]
                    });

                    setTimeout(() => { window.location.href = destinationUrl; }, 300); // Redireciona ap√≥s um pequeno atraso
                });
            });

            // Inicia o auto-scroll
            startAffiliateAutoScroll();

            // L√≥gica dos bot√µes de navega√ß√£o do carrossel
            const prevBtn = document.getElementById('affiliate-prev-btn');
            const nextBtn = document.getElementById('affiliate-next-btn');

            nextBtn.addEventListener('click', () => {
                pauseAffiliateAutoScroll();
                container.scrollBy({ left: container.offsetWidth / 2, behavior: 'smooth' });
            });

            prevBtn.addEventListener('click', () => {
                pauseAffiliateAutoScroll();
                container.scrollBy({ left: -container.offsetWidth / 2, behavior: 'smooth' });
            });

            // Pausa o scroll quando o mouse est√° sobre o container
            wrapper.addEventListener('mouseenter', () => clearInterval(affiliateAutoScrollInterval));

            // Reinicia o scroll quando o mouse sai
            wrapper.addEventListener('mouseleave', startAffiliateAutoScroll);
        }

        function startAffiliateAutoScroll() {
            // Limpa qualquer intervalo existente para evitar acelera√ß√£o
            if (affiliateAutoScrollInterval) clearInterval(affiliateAutoScrollInterval);

            const container = document.getElementById('affiliate-links-container');
            const track = document.getElementById('affiliate-track');

            // Ponto m√©dio onde o scroll deve ser reiniciado
            const scrollWidth = track.scrollWidth / 2;

            affiliateAutoScrollInterval = setInterval(() => {
                // Se o scroll passou do ponto m√©dio, reinicia silenciosamente
                if (container.scrollLeft >= scrollWidth) {
                    container.scrollLeft = 0;
                }
                // Move o scroll um pouco para a direita
                container.scrollLeft += 1;
            }, 25); // Ajuste este valor para mudar a velocidade (menor = mais r√°pido)
        }

        function pauseAffiliateAutoScroll() {
            // Limpa o intervalo de auto-scroll
            clearInterval(affiliateAutoScrollInterval);

            // Define um temporizador para reiniciar o auto-scroll ap√≥s um per√≠odo de inatividade
            let timeoutId;
            clearTimeout(timeoutId); // Limpa qualquer temporizador anterior
            timeoutId = setTimeout(() => {
                startAffiliateAutoScroll();
            }, 5000); // Reinicia ap√≥s 5 segundos
        }

        async function loadSupporters() {
            const carouselContainer = document.getElementById('supporters-carousel-container'); // Renamed for clarity
            const section = document.getElementById('supporters-section');
            const skeleton = document.getElementById('supporter-skeleton');
            const indicators = document.getElementById('supporter-indicators');

            // Carrega todos os apoiadores globais ativos e suas URLs de banner
            const [supportersResult, settingsResult] = await Promise.all([ // eslint-disable-line no-unused-vars
                dbClient.from('supporters').select('*').eq('is_active', true).order('name'),
                dbClient.from('site_settings').select('*').like('key', 'supporter_%_banner_url')
            ]);

            if (supportersResult.error || !supportersResult.data || supportersResult.data.length === 0) {
                if (supportersResult.error) console.error('Erro ao carregar apoiadores:', supportersResult.error);
                section.style.display = 'none'; // Hide the entire section if no supporters
                return;
            }

            const bannerUrls = (settingsResult.data || []).reduce((acc, setting) => {
                const supporterId = setting.key.match(/supporter_(\d+)_banner_url/)?.[1];
                if (supporterId) {
                    acc[supporterId] = setting.value;
                }
                return acc;
            }, {});

            const data = supportersResult.data.map(supporter => ({
                ...supporter,
                banner_url: bannerUrls[supporter.id]
            }));

            // Remove o skeleton antes de adicionar os banners reais
            if (skeleton) skeleton.remove();

            // Carousel state
            let currentSlide = 0;
            let slideInterval;

            const slidesWrapper = document.getElementById('supporter-slides-wrapper');

            const bannersHTML = data.map((supporter, index) => `
                <div class="supporter-slide flex-shrink-0 w-full h-full px-6" data-slide="${index}">
                    <a href="${supporter.website_url}" target="_blank" rel="noopener sponsored"
                       class="supporter-link block w-full h-full"
                       data-supporter-id="${supporter.id}" data-supporter-name="${supporter.name}">
                        <div class="relative w-full h-full bg-white flex items-center justify-center overflow-hidden rounded-2xl shadow-xl">
                            <img src="${supporter.banner_url || supporter.logo_url}" 
                                 alt="${supporter.name}" 
                                 class="w-auto h-full object-cover transform transition-transform duration-700 hover:scale-105"
                            <img src="${supporter.banner_url || supporter.logo_url}"
                                 alt="${supporter.name}"
                                 class="w-auto h-full object-contain transform transition-transform duration-700 hover:scale-105"
                                 loading="lazy" decoding="async" 
                                 style="image-rendering: -webkit-optimize-contrast;"
                                 onerror="this.onerror=null; this.src='/assets/error-state.svg'; this.classList.add('p-8', 'object-contain');">
                        </div>
                    </a>
                </div>
            `).join('');
            slidesWrapper.innerHTML = bannersHTML;

            const slides = slidesWrapper.querySelectorAll('.supporter-slide');
            const prevBtn = document.getElementById('supporter-prev');
            const nextBtn = document.getElementById('supporter-next');

            function updateDots() {
                const dots = indicators.querySelectorAll('button');
                dots.forEach((dot, i) => {
                    dot.classList.toggle('bg-emerald-500', i === currentSlide);
                    dot.classList.toggle('w-6', i === currentSlide);
                    dot.classList.toggle('bg-slate-300/50', i !== currentSlide);
                    dot.classList.toggle('w-2', i !== currentSlide);
                });
            }

            function showSlide(index) {
                if (index >= slides.length) index = 0;
                if (index < 0) index = slides.length - 1;

                currentSlide = index;
                slidesWrapper.style.transform = `translateX(${-currentSlide * 100}%)`;
                updateDots();
            }

            // Cria indicadores
            indicators.innerHTML = data.map((_, index) => `
                <button class="h-2 rounded-full transition-all duration-300 ease-in-out transform hover:scale-110"
                        data-indicator="${index}" 
                        aria-label="Go to slide ${index + 1}"></button>
            `).join('');

            // Configura√ß√£o do slideshow autom√°tico
            function startSlideshow() {
                if (slideInterval) clearInterval(slideInterval);
                if (data.length > 1) {
                    slideInterval = setInterval(() => {
                        showSlide(currentSlide + 1);
                    }, 6000);
                }
            }

            function stopSlideshow() {
                clearInterval(slideInterval);
            }

            // Event listeners for navigation buttons
            prevBtn.addEventListener('click', () => {
                stopSlideshow();
                showSlide(currentSlide - 1);
                startSlideshow();
            });
            nextBtn.addEventListener('click', () => {
                stopSlideshow();
                showSlide(currentSlide + 1);
                startSlideshow();
            });

            // Event listener para indicadores
            indicators.querySelectorAll('button').forEach(dot => {
                dot.addEventListener('click', () => {
                    const slideIndex = parseInt(dot.dataset.indicator, 10);
                    if (slideIndex !== currentSlide) {
                        stopSlideshow();
                        showSlide(slideIndex);
                        startSlideshow();
                    }
                });
            });

            // Pausa no hover
            carouselContainer.addEventListener('mouseenter', stopSlideshow);
            carouselContainer.addEventListener('mouseleave', startSlideshow);

            // Adiciona event listeners para os links
            slidesWrapper.querySelectorAll('.supporter-link').forEach(link => {
                link.addEventListener('click', () => {
                    logActivity('supporter_click', { // Registra o evento de clique
                        supporter_id: link.dataset.supporterId,
                        supporter_name: link.dataset.supporterName
                    });
                    gtag('event', 'select_promotion', {
                        'promotion_id': link.dataset.supporterId,
                        'promotion_name': link.dataset.supporterName,
                        supporter_id: link.dataset.supporterId,
                        supporter_name: link.dataset.supporterName
                    });
                });
            });

            // Initial setup
            showSlide(0);
            if (data.length > 1) {
                prevBtn.disabled = false;
                nextBtn.disabled = false;
                startSlideshow();
            } else {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                indicators.classList.add('hidden');
            }
        }

        async function loadFooterInfo() {
            const container = document.getElementById('footer-contact-info');
            const socialContainer = document.getElementById('social-media-links');
            if (!container || !socialContainer) return;

            try {
                const { data: contactData, error: contactError } = await dbClient
                    .from('site_settings')
                    .select('key, value')
                    .in('key', ['contact_email', 'contact_phone', 'company_nif']);
                if (contactError) throw contactError;

                const { data: socialData, error: socialError } = await dbClient
                    .from('site_settings')
                    .select('key, value')
                    .in('key', ['facebook_url', 'instagram_url', 'linkedin_url', 'whatsapp_url']);
                if (socialError) throw socialError;

                const settings = contactData.reduce((acc, { key, value }) => { acc[key] = value; return acc; }, {});

                let html = '';
                if (settings.contact_email) {
                    html += `<a href="mailto:${settings.contact_email}" class="inline-block mx-2 hover:text-white transition-colors">${settings.contact_email}</a>`;
                }
                if (settings.contact_phone) {
                    html += `<a href="tel:${settings.contact_phone}" class="inline-block mx-2 hover:text-white transition-colors">${settings.contact_phone}</a>`;
                }
                if (settings.company_nif) {
                    html += `<span class="inline-block mx-2">NIF: ${settings.company_nif}</span>`;
                }
                container.innerHTML = html;
            } catch (error) {
                console.error("Erro ao carregar informa√ß√µes de contato do rodap√©:", error);
            }
        }



        async function logActivity(type, details = {}) {
            try {
                if (!type) return; // N√£o faz nada se o tipo de evento n√£o for fornecido

                const identity = getOrCreateVisitorIdentity();

                // Adiciona o nome e o ID do visitante aos detalhes do evento
                const enrichedDetails = {
                    ...details,
                    visitor_name: identity.visitorName,
                    visitor_id: identity.visitorId,
                    url: window.location.href,
                    userAgent: navigator.userAgent
                };

                const payload = {
                    event_type: type,
                    session_id: identity.sessionId,
                    details: enrichedDetails
                };

                // Tenta enviar via WebSocket se a conex√£o estiver ativa
                if (ws && ws.readyState === WebSocket.OPEN) {
                    WebSocketModule.send({ type: 'log_activity', payload });
                    console.log(`[WS] Atividade '${type}' enviada.`);
                } else {
                    // Fallback para API HTTP
                    console.log(`[HTTP] WebSocket n√£o dispon√≠vel. A enviar '${type}' via API.`);
                    await fetch('/api/log-activity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
            } catch (error) {
                console.error('Erro ao registrar atividade:', error);
            }
        }

        async function initializeApp() {
            try {
                // Volta a usar o endpoint /api/config, que l√™ as vari√°veis de ambiente fornecidas pelo Railway
                const configResponse = await fetch('/api/config');
                if (!configResponse.ok) throw new Error('Falha ao carregar a configura√ß√£o do servidor.');
                const config = await configResponse.json();
                dbClient = supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);

                // A fun√ß√£o main() agora √© o ponto de entrada principal ap√≥s a configura√ß√£o.
                await main();

            } catch (error) {
                console.error("Erro de inicializa√ß√£o:", error);
                document.body.innerHTML = `<div class="p-8 m-8 text-center bg-red-100 text-red-800 rounded-lg"><strong>Erro Cr√≠tico:</strong> N√£o foi poss√≠vel carregar a configura√ß√£o da aplica√ß√£o. (${error.message})</div>`;
            }
        }



        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
    <script src="/js/cookie-consent.js"></script>

</body>

</html>