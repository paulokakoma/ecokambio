<!DOCTYPE html>
<html lang="pt" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - EcoKambio</title>
    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="/assets/favicon.svg">
    <link rel="shortcut icon" href="/assets/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/css/output.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes scroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        .scrolling-wrapper {
            animation: scroll 40s linear infinite;
        }

        /* Variáveis de Cor para um tema consistente */
        :root {
            --accent-color: #4f46e5;
            --accent-dark: #4338ca;
            --accent-light: #e0e7ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            /* Tom de cinza mais suave */
            color: #334155;
            /* Cor de texto padrão (slate-700) */
        }

        .sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-link svg {
            transition: color 0.2s ease;
        }

        .sidebar-link:not(.active):hover svg {
            color: white;
        }

        .sidebar-link {
            transition: all 0.2s ease;
            position: relative;
        }

        .sidebar-link.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 14px -4px rgba(79, 70, 229, 0.5);
        }

        .sidebar-link:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.08);
            transform: translateX(2px);
        }

        .sidebar-link.active svg {
            color: white;
        }

        /* Estilo de Card unificado */
        .card {
            background-color: white;
            border-radius: 1rem;
            /* 16px */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            /* border-gray-200 */
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .modal-overlay {
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            /* rounded-xl */
            padding: 0.75rem;
            /* p-3 */
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(16px);
        }

        .editable-cell {
            cursor: pointer;
            position: relative;
        }

        .editable-cell:hover {
            background-color: #fef9c3;
            border-radius: 4px;
        }

        /* bg-yellow-100 */
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-primary:hover {
            background-color: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .btn-secondary {
            background-color: white;
            color: #475569;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .admin-tab {
            position: relative;
            transition: all 0.2s ease;
        }

        .admin-tab.active-tab {
            border-color: var(--accent-color);
            color: var(--accent-color);
            font-weight: 600;
        }

        .admin-tab.active-tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-color);
            border-radius: 99px;
        }

        input[type="text"],
        input[type="email"],
        input[type="url"],
        input[type="tel"],
        input[type="number"],
        input[type="search"] {
            appearance: none;
            display: block;
            width: 100%;
            padding: 0.625rem 1rem;
            color: #111827;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            background-color: white;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="url"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        input[type="search"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-select {
            display: block;
            width: 100%;
            padding: 0.625rem 2.5rem 0.625rem 1rem;
            color: #111827;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border-radius: 0.5rem;
            background-color: white;
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea.form-textarea {
            display: block;
            width: 100%;
            padding: 0.625rem 1rem;
            color: #111827;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            background-color: white;
            transition: all 0.2s ease;
        }

        textarea.form-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Table Styles */
        .admin-table {
            border-radius: 1rem;
            /* Aumentado para 16px */
            overflow: hidden;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }

        .admin-table thead {
            background-color: #f9fafb;
            /* bg-gray-50 */
            border-bottom: 1px solid #e5e7eb;
            /* border-gray-200 */
        }

        .admin-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #6b7280;
            /* text-gray-500 */
            padding: 0.875rem 1.5rem;
        }

        .admin-table td {
            padding: 1rem 1.5rem;
            color: #374151;
            /* text-gray-700 */
        }

        .admin-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            /* border-gray-200 */
            transition: all 0.2s ease;
        }

        .admin-table tbody tr:hover {
            background-color: #f9fafb;
            /* bg-gray-50 */
        }

        .admin-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Cor de texto para perigo/erros */
        .text-danger-color {
            color: #dc2626;
            /* red-600 */
        }

        /* Adiciona cursor de ponteiro para itens de legenda clicáveis */
        .legend-item {
            cursor: pointer;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <aside
        class="sidebar w-64 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col fixed lg:relative inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 z-30 shadow-xl">
        <div class="px-6 py-5 flex items-center justify-between border-b border-slate-700/50">
            <h1 class="text-xl font-bold text-white">EcoKambio</h1>
            <button id="close-sidebar-btn" class="lg:hidden text-slate-400 hover:text-white">&times;</button>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-1">
            <a href="#dashboard" class="sidebar-link active flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="#bancos" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3">
                    </path>
                </svg>
                <span>Bancos</span>
            </a>
            <a href="#mercado_informal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Mercado Informal</span>
            </a>
            <a href="#afiliados" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                    </path>
                </svg>
                <span>Afiliados</span>
            </a>
            <a href="#apoiadores" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                <span>Apoiadores</span>
            </a>
            <a href="#moedas" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Moedas</span>
            </a>
            <a href="#cartao_visa" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z">
                    </path>
                </svg>
                <span>Cartão Visa</span>
            </a>
            <div class="border-t border-slate-700/50 my-4"></div>
            <a href="#configuracoes" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Configurações</span>
            </a>
        </nav>
        <div class="p-4 mt-auto">
            <button id="logout-btn"
                class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-red-500/10 hover:text-red-400 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                <span>Sair</span>
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col bg-slate-50">
        <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between border-b border-slate-200">
            <div class="flex items-center space-x-4">
                <button id="open-sidebar-btn" class="lg:hidden text-slate-600 hover:text-slate-900 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h2 class="text-lg font-semibold text-slate-900 hidden lg:block" id="current-section-title">Dashboard
                </h2>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-slate-700">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="font-medium">Admin</span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 md:p-8">
            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section space-y-8">

                <!-- Cabeçalho da Seção -->
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-text-primary" id="welcome-message">Boas-vindas, Admin!</h2>
                        <p class="text-text-secondary mt-1">Aqui está um resumo da atividade da sua plataforma.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="force-refresh-btn" class="btn btn-secondary">
                            <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                                    clip-rule="evenodd" />
                            </svg>
                            <svg id="refresh-spinner" class="w-5 h-5 animate-spin hidden"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span>Atualizar</span>
                        </button>
                    </div>
                </div>

                <!-- Grade de Estatísticas -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6">
                    <!-- Card: Online Agora -->
                    <div class="card p-5 flex items-center gap-4 fade-in-up" style="animation-delay: 0ms;">
                        <div class="stat-card-icon bg-blue-100 text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-text-secondary font-medium text-sm">Online Agora</h4>
                            <p class="text-2xl font-bold text-text-primary mt-1" id="online-users-stat">--</p>
                        </div>
                    </div>
                    <!-- Card: Acessos Hoje -->
                    <div class="card p-5 flex items-center gap-4 fade-in-up" style="animation-delay: 100ms;">
                        <div class="stat-card-icon bg-green-100 text-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-text-secondary font-medium text-sm">Acessos Hoje</h4>
                            <p class="text-2xl font-bold text-text-primary mt-1" id="today-access-stat">--</p>
                        </div>
                    </div>
                    <!-- Card: Acessos Semana (NOVO) -->
                    <div class="card p-5 flex items-center gap-4 fade-in-up" style="animation-delay: 200ms;">
                        <div class="stat-card-icon bg-sky-100 text-sky-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l-4 4m0 0l4-4m-4 4h4" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-text-secondary font-medium text-sm">Acessos Semana</h4>
                            <p class="text-2xl font-bold text-text-primary mt-1" id="weekly-access-stat">--</p>
                        </div>
                    </div>
                    <!-- Card: Acessos Mês (NOVO) -->
                    <div class="card p-5 flex items-center gap-4 fade-in-up" style="animation-delay: 300ms;">
                        <div class="stat-card-icon bg-yellow-100 text-yellow-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-text-secondary font-medium text-sm">Acessos Mês</h4>
                            <p class="text-2xl font-bold text-text-primary mt-1" id="monthly-access-stat">--</p>
                        </div>
                    </div>
                    <!-- Card: Novos Visitantes (Hoje) -->
                    <div class="card p-5 flex items-center gap-4 fade-in-up" style="animation-delay: 400ms;">
                        <div class="stat-card-icon bg-purple-100 text-purple-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-text-secondary font-medium text-sm">Novos Visitantes (Hoje)</h4>
                            <p class="text-2xl font-bold text-text-primary mt-1" id="new-visitors-stat">--</p>
                        </div>
                    </div>
                    <!-- Card: Cliques Afiliados (Mês) -->
                    <div class="card p-5 flex items-center gap-4 fade-in-up" style="animation-delay: 500ms;">
                        <div class="stat-card-icon bg-orange-100 text-orange-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-text-secondary font-medium text-sm">Cliques Afiliados (Mês)</h4>
                            <p class="text-2xl font-bold text-text-primary mt-1" id="affiliate-clicks-stat">--</p>
                        </div>
                    </div>
                </div>

                <!-- Gráfico Principal -->
                <div class="card p-6 fade-in-up" style="animation-delay: 600ms;">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-lg font-bold text-text-primary">Atividade Mensal</h3>
                        <select id="activity-period-selector" class="form-select !w-auto !py-1.5 text-sm">
                            <optgroup label="Visão Geral">
                                <option value="6" selected>Últimos 6 meses</option>
                                <option value="12">Últimos 12 meses</option>
                                <option value="all">Todo o período</option>
                            </optgroup>
                            <optgroup label="Por Mês (Semanas)" id="monthly-drilldown-options">
                                <!-- Preenchido dinamicamente pelo JS -->
                            </optgroup>
                        </select>
                    </div>
                    <div class="h-80 relative overflow-x-auto scrollbar-hide">
                        <div class="min-w-[600px] h-full">
                            <canvas id="weeklyActivityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gráficos Secundários / Feeds -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Feed de Atividade -->
                    <div class="card p-6 lg:col-span-1 fade-in-up" style="animation-delay: 700ms;">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="activity-feed-title" class="text-lg font-bold text-text-primary">Atividade Recente
                            </h3>
                            <button id="clear-activity-filter-btn"
                                class="hidden text-xs font-semibold text-blue-600 hover:text-blue-800">Limpar
                                Filtro</button>
                        </div>
                        <div id="realtime-feed" class="space-y-4 max-h-96 overflow-y-auto pr-2 scrollbar-hide">
                            <!-- Exemplo de item de feed -->
                            <div class="flex gap-3">
                                <div class="stat-card-icon !p-2 !rounded-lg bg-green-100 text-green-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">Banco <span
                                            class="font-bold">BFA</span> atualizado com sucesso.</p>
                                    <span class="text-xs text-text-secondary">Agora mesmo</span>
                                </div>
                            </div>
                            <!-- Exemplo de item de feed 2 -->
                            <div class="flex gap-3">
                                <div class="stat-card-icon !p-2 !rounded-lg bg-blue-100 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path
                                            d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 11a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1v-1z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">Novo apoiador <span
                                            class="font-bold">Unitel</span> adicionado.</p>
                                    <span class="text-xs text-text-secondary">Há 2 minutos</span>
                                </div>
                            </div>
                            <!-- Exemplo de item de feed 3 -->
                            <div class="flex gap-3">
                                <div class="stat-card-icon !p-2 !rounded-lg bg-red-100 text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">Falha ao atualizar câmbio do <span
                                            class="font-bold">Mercado Informal</span>.</p>
                                    <span class="text-xs text-text-secondary">Há 15 minutos</span>
                                </div>
                            </div>
                            <!-- Placeholder -->
                            <!-- <div id="realtime-feed" class="space-y-3 max-h-96 overflow-y-auto pr-2"><p class="text-sm text-slate-400 text-center py-8">A aguardar por atividade...</p></div> -->
                        </div>
                    </div>
                    <!-- Métricas de Engajamento -->
                    <div class="card p-6 lg:col-span-1 fade-in-up" style="animation-delay: 800ms;">
                        <h3 class="text-lg font-bold text-text-primary mb-4">Métricas de Engajamento</h3>

                        <!-- Gráfico Donut -->
                        <h4 class="text-md font-semibold text-text-primary mb-2 mt-6">Tipos de Eventos</h4>
                        <div id="event-types-chart-container" class="flex items-center gap-6 h-56">
                            <div class="relative h-full w-1/2">
                                <canvas id="eventTypesChart"></canvas>
                            </div>
                            <div id="event-types-legend" class="w-1/2 space-y-2 text-sm"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bancos Section -->
            <section id="bancos" class="admin-section hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Gerir Bancos</h2>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4 w-full md:w-auto">
                        <input type="search" id="bank-search-input" placeholder="Procurar por nome ou código..."
                            class="w-full md:w-64 px-4 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button id="add-bank-btn" class="btn-primary flex-shrink-0">Adicionar Banco</button>
                    </div>
                </div>
                <div class="admin-table">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[800px]">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-left">BANCO</th>
                                    <th scope="col" class="text-left">cambio USD/AOA</th>
                                    <th scope="col" class="text-left">cambio EUR/AOA</th>
                                    <th scope="col" class="text-left">Última atualização</th>
                                    <th scope="col" class="text-left">COMISSÃO (%)</th>
                                    <th scope="col" class="text-left">COMISSÃO BASE (%)</th>
                                    <th scope="col">STATUS</th>
                                    <th scope="col" class="text-center">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody id="banks-table-body">
                                <tr class="h-48">
                                    <td colspan="8" class="text-center">
                                        <div class="loader mx-auto"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Mercado Informal Section -->
            <section id="mercado_informal" class="admin-section hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Gerir Mercado Informal</h2>
                </div>
                <div class="bg-white rounded-lg shadow p-6 md:p-8">
                    <div class="border-b border-gray-200 mb-6 flex items-center justify-between gap-4">
                        <nav id="informal-province-tabs"
                            class="-mb-px flex space-x-6 md:space-x-8 overflow-x-auto scrollbar-hide" aria-label="Tabs">
                        </nav><button id="add-province-btn"
                            class="btn-secondary mb-px flex-shrink-0 flex items-center space-x-2 text-sm"><svg
                                xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg> <span>Adicionar</span></button>
                    </div>
                    <div id="informal-rates-content" class="min-h-[200px] flex items-center justify-center pt-4">
                        <div class="loader"></div>
                    </div>
                </div>
            </section>

            <!-- Afiliados Section -->
            <section id="afiliados" class="admin-section hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Gerir Links de Afiliados</h2>
                    <div class="flex items-center gap-4">
                        <input type="search" id="affiliate-search-input" placeholder="Procurar por título..."
                            class="w-full md:w-64">
                        <button id="add-affiliate-btn" class="btn-primary flex-shrink-0">Adicionar Link</button>
                    </div>
                </div>
                <div class="admin-table">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[700px]">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-left">Produto</th>
                                    <th scope="col" class="text-center">Preço</th>
                                    <th scope="col" class="text-center">Cliques</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="affiliates-table-body">
                                <tr class="h-48">
                                    <td colspan="5" class="text-center">
                                        <div class="loader mx-auto"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Apoiadores Section -->
            <section id="apoiadores" class="admin-section hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Gerir Apoiadores</h2><button id="add-supporter-btn"
                        class="btn-primary">Adicionar Apoiador</button>
                </div>
                <div class="admin-table">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[600px]">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-left">Apoiador</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="supporters-table-body">
                                <tr class="h-48">
                                    <td colspan="3" class="text-center">
                                        <div class="loader mx-auto"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Moedas Section -->
            <section id="moedas" class="admin-section hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Gerir Moedas</h2><button id="add-currency-btn"
                        class="btn-primary">Adicionar Moeda</button>
                </div>
                <div class="admin-table">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[600px]">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-left">Código</th>
                                    <th scope="col" class="text-left">Nome</th>
                                    <th scope="col" class="text-left">Símbolo</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="currencies-table-body">
                                <tr class="h-48">
                                    <td colspan="5" class="text-center">
                                        <div class="loader mx-auto"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Cartão Visa Section -->
            <section id="cartao_visa" class="admin-section hidden">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Gerir Cartão Visa</h2>
                <div class="card p-6 md:p-8 max-w-3xl mx-auto">
                    <form id="visa-settings-form" class="space-y-6">
                        <!-- Valores e Taxas -->
                        <div class="pb-4">
                            <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center space-x-2">
                                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                                <span>Valores e Taxas</span>
                            </h3>
                            <div class="mb-4"><label for="visa_setting_title"
                                    class="block text-sm font-medium text-slate-700">Título Principal</label><input
                                    type="text" id="visa_setting_title" name="visa_title" class="mt-1"></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="mb-4 md:mb-0"><label for="visa_fee_percent"
                                        class="block text-sm font-medium text-slate-700">Taxa (%)</label><input
                                        type="number" id="visa_fee_percent" name="visa_fee_percent" class="mt-1"
                                        placeholder="Ex: 5.5" step="0.1"></div>
                                <div><label for="visa_setting_min_load"
                                        class="block text-sm font-medium text-slate-700">Carregamento Mínimo
                                        (USD)</label><input type="number" id="visa_setting_min_load"
                                        name="visa_min_load" class="mt-1" placeholder="Ex: 50"></div>
                            </div>
                        </div>

                        <!-- Imagem do Cartão -->
                        <div class="pt-6 border-t border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center space-x-2">
                                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                                <span>Imagem do Cartão</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <img id="visa-image-preview" src="/assets/visa.png" alt="Prévia da imagem do cartão"
                                    class="h-24 w-auto rounded-lg shadow-md border border-slate-200">
                                <div>
                                    <label for="visa_image_upload"
                                        class="cursor-pointer text-sm font-medium text-indigo-600 hover:text-indigo-800">Trocar
                                        imagem...</label>
                                    <input type="file" id="visa_image_upload" name="visa_image" class="hidden"
                                        accept="image/*">
                                    <p class="text-xs text-slate-500 mt-1">A imagem será otimizada para a web.</p>
                                </div>
                            </div>
                            <div id="visa-upload-progress-container" class="hidden pt-4">
                                <p id="visa-upload-progress-text" class="text-center text-sm text-slate-600 mb-2"></p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="visa-upload-progress-bar"
                                        class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Link de Ação -->
                        <div class="pt-6 border-t border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center space-x-2">
                                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z">
                                    </path>
                                </svg>
                                <span>Link de Ação</span>
                            </h3>
                            <div><label for="visa_setting_whatsapp_number"
                                    class="block text-sm font-medium text-slate-700">Número de WhatsApp para o CTA (ex:
                                    244912345678)</label><input type="tel" id="visa_setting_whatsapp_number"
                                    name="visa_whatsapp_number" class="mt-1"></div>
                        </div>

                        <div class="flex justify-end pt-4"><button type="submit" class="btn-primary">Guardar
                                Alterações</button></div>
                    </form>
                </div>
            </section>

            <!-- Configurações Section -->
            <section id="configuracoes" class="admin-section hidden">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Configurações Gerais</h2>
                <div class="card p-6 md:p-8 max-w-3xl mx-auto">
                    <form id="settings-form" class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">Informações de Contato
                            </h3>
                        </div>
                        <div><label for="setting_contact_email" class="block text-sm font-medium text-slate-700">Email
                                de Contato</label><input type="email" name="contact_email" id="setting_contact_email"
                                class="mt-1"></div>
                        <div><label for="setting_contact_phone"
                                class="block text-sm font-medium text-slate-700">Telefone de Contato</label><input
                                type="tel" name="contact_phone" id="setting_contact_phone" class="mt-1"></div>
                        <div class="pt-4">
                            <h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">Calculadora</h3>
                        </div>
                        <div class="pt-4">
                            <h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">Redes Sociais Padrão
                            </h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                            <div><label for="setting_social_whatsapp"
                                    class="block text-sm font-medium text-slate-700">WhatsApp</label><input type="url"
                                    name="whatsapp" id="setting_social_whatsapp" class="mt-1"></div>
                            <div><label for="setting_social_instagram"
                                    class="block text-sm font-medium text-slate-700">Instagram</label><input type="url"
                                    name="instagram" id="setting_social_instagram" class="mt-1"></div>
                            <div><label for="setting_social_facebook"
                                    class="block text-sm font-medium text-slate-700">Facebook</label><input type="url"
                                    name="facebook" id="setting_social_facebook" class="mt-1"></div>
                            <div><label for="setting_social_tiktok"
                                    class="block text-sm font-medium text-slate-700">TikTok</label><input type="url"
                                    name="tiktok" id="setting_social_tiktok" class="mt-1"></div>
                            <div><label for="setting_social_youtube"
                                    class="block text-sm font-medium text-slate-700">YouTube</label><input type="url"
                                    name="youtube" id="setting_social_youtube" class="mt-1"></div>
                        </div>
                        <div class="flex justify-end pt-4"><button type="submit" class="btn-primary">Guardar
                                Configurações</button></div>
                    </form>

                    <div class="mt-12 pt-6 border-t border-red-200">
                        <h3 class="text-lg font-semibold text-red-700 mb-4">Zona de Perigo</h3>
                        <p class="text-sm text-slate-600 mb-4">A ação abaixo é irreversível. Tenha a certeza do que está
                            a fazer.</p>
                        <button id="reset-stats-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Zerar
                            Todas as Estatísticas</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Overlay para Sidebar Mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 lg:hidden hidden"></div>

    <!-- Modals & Overlays -->
    <div id="modals-and-overlays-container">
        <!-- Modal: Bancos -->
        <div id="bank-modal"
            class="modal-overlay fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-40">
            <div
                class="modal-content bg-white rounded-xl shadow-xl p-6 md:p-8 w-full max-w-md transform scale-95 border border-slate-200 max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold text-slate-800 mb-6" id="bank-modal-title">Adicionar Novo Banco</h3>
                <form id="bank-form">
                    <input type="hidden" id="bank-id-input">
                    <div class="space-y-4">
                        <div><label for="bank_code" class="block text-sm font-medium text-slate-700">Código (ex:
                                BAI)</label><input type="text" id="bank_code" name="bank_code" required class="mt-1"
                                maxlength="10"></div>
                        <div><label for="bank_name" class="block text-sm font-medium text-slate-700">Nome
                                Completo</label><input type="text" id="bank_name" name="bank_name" required
                                class="mt-1"></div>
                        <div><label for="bank_logo_url" class="block text-sm font-medium text-slate-700">URL do
                                Logo</label><input type="url" id="bank_logo_url" name="bank_logo_url" class="mt-1"
                                placeholder="https://.../logo.png"></div>
                        <div><label for="bank_usd_rate" class="block text-sm font-medium text-slate-700">Cotação
                                USD/AOA</label><input type="number" id="bank_usd_rate" name="bank_usd_rate"
                                step="0.0001" required class="mt-1"></div>
                        <div><label for="bank_eur_rate" class="block text-sm font-medium text-slate-700">Cotação
                                EUR/AOA</label><input type="number" id="bank_eur_rate" name="bank_eur_rate"
                                step="0.0001" required class="mt-1"></div>
                        <div><label for="bank_commission" class="block text-sm font-medium text-slate-700">Comissão
                                (%)</label><input type="number" id="bank_commission" name="bank_commission" step="0.01"
                                value="3" required class="mt-1">
                            <p class="mt-1 text-xs text-slate-500">Comissão aplicada sobre o valor em AOA (padrão: 3%)
                            </p>
                        </div>
                        <div><label for="bank_base_fee" class="block text-sm font-medium text-slate-700">Comissão Base
                                da Calculadora (%)</label><input type="number" id="bank_base_fee" name="bank_base_fee"
                                step="0.01" value="12" required class="mt-1">
                            <p class="mt-1 text-xs text-slate-500">Esta comissão é adicionada ao valor em AOA antes de
                                aplicar as taxas do banco (padrão: 12%)</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-8"><button type="button" class="btn-secondary"
                            data-modal-hide="bank-modal">Cancelar</button><button type="submit"
                            class="btn-primary">Guardar</button></div>
                </form>
            </div>
        </div>

        <!-- Modal: Moedas -->
        <div id="currency-modal"
            class="modal-overlay fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
            <div
                class="modal-content bg-white rounded-xl shadow-xl p-6 md:p-8 w-full max-w-md transform scale-95 border border-slate-200 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div
                            class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full bg-teal-100 text-teal-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <h3 id="currency-modal-title" class="text-2xl font-bold text-slate-800">Adicionar Nova Moeda
                        </h3>
                    </div>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        data-modal-hide="currency-modal">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="currency-form" class="space-y-4">
                    <input type="hidden" id="currency_id" name="currency_id">
                    <div><label for="currency_code" class="block text-sm font-medium text-slate-700">Código (ex:
                            USD)</label><input type="text" name="currency_code" id="currency_code" class="mt-1" required
                            maxlength="10"></div>
                    <div><label for="currency_name" class="block text-sm font-medium text-slate-700">Nome (ex: Dólar
                            Americano)</label><input type="text" name="currency_name" id="currency_name" class="mt-1"
                            required></div>
                    <div><label for="currency_symbol" class="block text-sm font-medium text-slate-700">Símbolo (ex:
                            $)</label><input type="text" name="currency_symbol" id="currency_symbol" class="mt-1"
                            maxlength="5"></div>
                    <div class="flex justify-end space-x-4 pt-4"><button type="button" class="btn-secondary"
                            data-modal-hide="currency-modal">Cancelar</button><button type="submit"
                            id="save-currency-btn" class="btn-primary">Adicionar</button></div>
                </form>
            </div>
        </div>

        <!-- Modal: Afiliados -->
        <div id="affiliate-modal"
            class="modal-overlay fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
            <div
                class="modal-content bg-white rounded-xl shadow-xl p-6 md:p-8 w-full max-w-md transform scale-95 border border-slate-200 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div
                            class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full bg-purple-100 text-purple-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                                </path>
                            </svg>
                        </div>
                        <h3 id="affiliate-modal-title" class="text-2xl font-bold text-slate-800">Adicionar Novo Link
                        </h3>
                    </div>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        data-modal-hide="affiliate-modal">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="affiliate-form" class="space-y-4">
                    <input type="hidden" id="affiliate_id" name="affiliate_id">
                    <div><label for="affiliate_title" class="form-label">Título do Produto</label><input type="text"
                            name="affiliate_title" id="affiliate_title" required></div>
                    <div><label for="affiliate_url" class="form-label">URL de Afiliado (Link de Compra)</label><input
                            type="url" name="affiliate_url" id="affiliate_url" required></div>
                    <div><label for="affiliate_image_url" class="form-label">URL da Imagem do Produto</label><input
                            type="url" name="affiliate_image_url" id="affiliate_image_url"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="affiliate_price" class="form-label">Preço do Produto (USD)</label><input
                                type="number" step="0.01" name="affiliate_price" id="affiliate_price"></div>
                        <div><label for="affiliate_shipping" class="form-label">Custo de Frete (USD)</label><input
                                type="number" step="0.01" name="affiliate_shipping" id="affiliate_shipping"></div>
                    </div>
                    <div><label for="affiliate_proof_video_url" class="form-label">URL do Vídeo de Prova
                            (Opcional)</label><input type="url" name="affiliate_proof_video_url"
                            id="affiliate_proof_video_url"></div>
                    <div><label for="affiliate_tutorial_video_url" class="form-label">URL do Vídeo Tutorial
                            (Compra)</label><input type="url" name="affiliate_tutorial_video_url"
                            id="affiliate_tutorial_video_url"></div>
                    <div class="flex justify-end space-x-4 mt-8"><button type="button" class="btn-secondary"
                            data-modal-hide="affiliate-modal">Cancelar</button><button type="submit"
                            id="save-affiliate-btn" class="btn-primary">Adicionar</button></div>
                </form>
            </div>
        </div>

        <!-- Modal: Províncias -->
        <div id="province-modal"
            class="modal-overlay fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
            <div
                class="modal-content bg-white rounded-xl shadow-xl p-6 md:p-8 w-full max-w-md transform scale-95 border border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div
                            class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full bg-cyan-100 text-cyan-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h3 id="province-modal-title" class="text-2xl font-bold text-slate-800">Adicionar Província</h3>
                    </div>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        data-modal-hide="province-modal">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="province-form" class="space-y-4">
                    <input type="hidden" id="province_id" name="province_id">
                    <div><label for="province_name" class="block text-sm font-medium text-slate-700">Nome da
                            Província</label><input type="text" name="province_name" id="province_name" class="mt-1"
                            required></div>
                    <div class="flex justify-end space-x-4 pt-4"><button type="button" class="btn-secondary"
                            data-modal-hide="province-modal">Cancelar</button><button type="submit"
                            id="save-province-btn" class="btn-primary">Adicionar</button></div>
                </form>
            </div>
        </div>

        <!-- Modal: Apoiadores -->
        <div id="supporter-modal"
            class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40 p-4">
            <div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-lg transform scale-95">
                <h3 id="supporter-modal-title" class="text-2xl font-bold text-slate-800 mb-6">Adicionar Novo Apoiador
                </h3>
                <form id="supporter-form" class="space-y-4" enctype="multipart/form-data">
                    <input type="hidden" id="supporter_id" name="supporter_id">
                    <div><label for="supporter_name" class="block text-sm font-medium text-slate-700">Nome do
                            Apoiador</label><input type="text" name="supporter_name" id="supporter_name" class="mt-1"
                            required></div>
                    <div><label for="supporter_website_url" class="block text-sm font-medium text-slate-700">URL do
                            Website</label><input type="url" name="supporter_website_url" id="supporter_website_url"
                            class="mt-1" required></div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Imagem do Banner</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                            <div class="w-40 h-40"><label for="supporter_banner"
                                    class="cursor-pointer flex flex-col items-center justify-center w-full h-full border-2 border-gray-300 border-dashed rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition-colors"><svg
                                        class="w-8 h-8 text-gray-400 mb-2" xmlns="http://www.w3.org/2000/svg"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h1.586a1 1 0 01.707.293l1.414 1.414a1 1 0 00.707.293H12a4 4 0 014 4v1.586a1 1 0 00.293.707l1.414 1.414a1 1 0 01.293.707V16a4 4 0 01-4 4H7z" />
                                    </svg><span id="supporter_banner_name" class="text-center px-2">Escolher
                                        imagem...</span><input type="file" id="supporter_banner" name="supporter_banner"
                                        class="hidden" accept="image/*"></label></div>
                            <div id="supporter_banner_preview"
                                class="w-40 h-40 border rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden">
                                <span class="text-gray-400 text-sm">Prévia</span>
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Tamanho recomendado: 1500x530 pixels. A imagem será
                            otimizada.</p>
                    </div>
                    <div id="supporter-upload-progress-container" class="hidden pt-2">
                        <p id="supporter-upload-progress-text" class="text-center text-sm text-slate-600 mb-2"></p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="supporter-upload-progress-bar"
                                class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4"><button type="button" class="btn-secondary"
                            data-modal-hide="supporter-modal">Cancelar</button><button type="submit"
                            id="save-supporter-btn" class="btn-primary">Adicionar</button></div>
                </form>
            </div>
        </div>

        <!-- Modal: Confirmação de Exclusão -->
        <div id="delete-confirm-modal"
            class="modal-overlay fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
            <div
                class="modal-content bg-white rounded-xl shadow-xl p-6 md:p-8 w-full max-w-md transform scale-95 border border-slate-200">
                <div class="flex items-start space-x-4">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg leading-6 font-bold text-slate-900" id="delete-confirm-title">Confirmar
                            Exclusão</h3>
                        <p id="delete-confirm-message" class="mt-2 text-sm text-slate-600">Tem a certeza que deseja
                            apagar este item? Esta ação é irreversível.</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div id="delete-confirm-input-container" class="hidden">
                        <label for="delete-confirm-input" class="form-label mb-2">Para confirmar, digite <strong
                                class="text-danger-color">resetar</strong> abaixo:</label>
                        <input type="text" id="delete-confirm-input" autocomplete="off">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-delete-btn" class="btn-secondary">Cancelar</button>
                    <button type="button" id="confirm-delete-btn"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Apagar</button>
                </div>
            </div>
        </div>

        <!-- Notifications (Toasts) -->
        <div id="toast-notification"
            class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-out z-50">
            <p id="toast-message"></p>
        </div>
        <div id="error-notification"
            class="fixed top-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-out z-50">
            <p id="error-message"></p>
        </div>
    </div>

    <script type="module">
        // --- CONFIG & INIT ---
        const API_BASE_URL = ''; // As chamadas serão relativas ao domínio atual

        // Constrói a URL do WebSocket para apontar sempre para o subdomínio 'admin'.
        function getWebSocketURL() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const parts = host.split('.');
            // Se já estiver no subdomínio admin (ou localhost), usa o host atual.
            if (parts[0] === 'admin' || host.startsWith('localhost')) {
                return `${protocol}//${host}`;
            }
            // Caso contrário, adiciona 'admin.' ao host.
            return `${protocol}//admin.${host}`;
        }
        const WEBSOCKET_URL = getWebSocketURL();

        let allFormalProviders = [], allInformalProviders = [], allAffiliates = [], allCurrencies = [], allSupporters = [], _weeklyChartInstance, _affiliateChartInstance, _tabVisitsChartInstance;
        let activitySessions = new Map(); // Para agrupar atividades por sessão
        let currentActivityFilter = null; // Para guardar o filtro de atividade atual
        let _eventTypesChartInstance; // Variável para a instância do novo gráfico

        // Funções de notificação definidas no início para uso global
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-x-[120%]');
            setTimeout(() => toast.classList.add('translate-x-[120%]'), 3000);
        }

        function showError(message) {
            const errorToast = document.getElementById('error-notification');
            const errorMsg = document.getElementById('error-message');
            if (errorMsg) errorMsg.textContent = message;
            if (errorToast) {
                errorToast.classList.remove('translate-x-[120%]');
                setTimeout(() => errorToast.classList.add('translate-x-[120%]'), 4000);
            } else {
                console.error('Erro:', message);
                alert(message); // Fallback se o elemento não existir
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            init();
        }
        async function init() {
            updateViewForHash(window.location.hash || '#dashboard');
            loadAllData();
            initAnimations();
            setupEventListeners();
            startPolling(); // Inicia o polling para atualizações regulares
            setupSupporterBannerPreview(); // Configura o preview do banner
            connectAdminWebSocket(); // Reativado para dados em tempo real
        }

        // --- NAVIGATION ---
        function updateViewForHash(hash) {
            const effectiveHash = (hash && document.querySelector(hash)) ? hash : '#dashboard';
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(effectiveHash)?.classList.remove('hidden');
            document.querySelector(`.sidebar-link[href="${effectiveHash}"]`)?.classList.add('active');
        }

        // --- DATA LOADING ---
        async function loadAllData() {
            await Promise.all([
                loadDashboardData(),
                loadRecentActivity(),
                loadBanks(),
                loadCurrencies(),
                loadInformalRates(),
                loadAffiliateLinks(),
                loadSupporters(),
                loadSettings(),
                loadVisaSettings()
            ]);
            // Renderiza os gráficos e preenche seletores APÓS os dados principais serem carregados
            await Promise.all([
                renderDashboardCharts(),
                renderEventTypesChart()
            ]);
            // Preenche o seletor de meses APÓS o primeiro carregamento do gráfico
            populateMonthSelector();
        }

        async function loadBanks() {
            const banksTableBody = document.getElementById('banks-table-body');
            banksTableBody.innerHTML = `<tr><td colspan="8" class="text-center h-48"><div class="loader mx-auto"></div></td></tr>`;

            try {
                const data = await apiCall('/api/rate_providers?type=FORMAL', 'GET');
                allFormalProviders = data;
                renderBanks(allFormalProviders);
            } catch (error) {
                banksTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500">Erro ao carregar bancos.</td></tr>`;
            }
        }

        function renderBanks(providers) {
            const banksTableBody = document.getElementById('banks-table-body');
            banksTableBody.innerHTML = '';
            if (!providers || providers.length === 0) {
                banksTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-500">Nenhum banco encontrado.</td></tr>`;
                return;
            }
            banksTableBody.innerHTML = providers.map(bank => {
                const usdRate = bank.usd_rate || 0;
                const eurRate = bank.eur_rate || 0;
                const commission = bank.fee_margin ?? 0;
                const baseFee = bank.base_fee_percent || 12;

                return `
                <tr>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-4">
                            ${bank.logo_url
                        ? `<img src="${bank.logo_url}" alt="Logo ${bank.name}" class="h-10 w-10 object-contain rounded-md bg-white border border-slate-200 shadow-sm">`
                        : `<div class="h-10 w-10 rounded-md bg-slate-100 flex items-center justify-center text-slate-400 text-xs font-bold border border-slate-200">${bank.code}</div>`
                    }
                            <span class="font-bold text-slate-800">${bank.code || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="editable-cell inline-block min-w-[100px] px-2" data-field="sell_rate" data-pair="USD/AOA" data-provider-id="${bank.id}">
                            ${usdRate > 0 ? usdRate.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 }) : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="editable-cell inline-block min-w-[100px] px-2" data-field="sell_rate" data-pair="EUR/AOA" data-provider-id="${bank.id}">
                            ${eurRate > 0 ? eurRate.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 }) : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-block min-w-[150px] px-2 text-slate-500" data-field="last_updated" data-provider-id="${bank.id}">
                            ${bank.last_updated ? new Date(bank.last_updated).toLocaleString('pt-PT', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="editable-cell inline-block min-w-[80px] px-2" data-field="fee_margin" data-provider-id="${bank.id}">
                            ${commission.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}%
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="editable-cell inline-block min-w-[80px] px-2" data-field="base_fee_percent" data-provider-id="${bank.id}">
                            ${baseFee.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}%
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-status" data-type="bank" ${bank.is_active ? 'checked' : ''} data-id="${bank.id}">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td class="px-6 py-4 text-center space-x-2">
                        <button class="edit-btn inline-flex items-center gap-1.5 text-sm font-semibold p-2 rounded-md text-amber-600 hover:text-amber-700 hover:bg-amber-100 transition-colors" data-type="bank" data-id="${bank.id}" title="Editar">
                            <svg class="w-4 h-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button class="delete-btn inline-flex items-center gap-1.5 text-sm font-semibold p-2 rounded-md text-red-600 hover:text-red-700 hover:bg-red-100 transition-colors" data-type="bank" data-id="${bank.id}" title="Apagar">
                            <svg class="w-4 h-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function loadCurrencies() {
            const tableBody = document.getElementById('currencies-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center h-48"><div class="loader mx-auto"></div></td></tr>`;
            try {
                const data = await apiCall('/api/currencies', 'GET');
                allCurrencies = data;
                tableBody.innerHTML = data.length === 0
                    ? `<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma moeda encontrada.</td></tr>`
                    : data.map(currency => `
                    <tr data-currency-id="${currency.id}">
                        <td class="px-6 py-4 font-medium text-gray-900">${currency.code}</td>
                        <td class="px-6 py-4">${currency.name}</td>
                        <td class="px-6 py-4 text-center">${currency.symbol || ''}</td>
                        <td class="px-6 py-4"><label class="toggle-switch"><input type="checkbox" class="toggle-status" data-type="currency" ${currency.is_active ? 'checked' : ''} data-id="${currency.id}"><span class="toggle-slider"></span></label></td>
                        <td class="px-6 py-4 text-center space-x-2">
                            <button class="edit-btn p-2 rounded-md text-amber-600 hover:text-amber-700 hover:bg-amber-100 transition-colors" data-type="currency" data-id="${currency.id}" title="Editar">
                                <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                            </button>
                            <button class="delete-btn p-2 rounded-md text-red-600 hover:text-red-700 hover:bg-red-100 transition-colors" data-type="currency" data-id="${currency.id}" title="Apagar">
                                <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            </button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Erro ao carregar moedas.</td></tr>`;
            }
        }

        async function loadInformalRates() {
            const contentContainer = document.getElementById('informal-rates-content');
            try {
                const data = await apiCall('/api/rate_providers?type=INFORMAL', 'GET');
                allInformalProviders = data.map(p => ({
                    id: p.id,
                    name: p.name,
                    exchange_rates: [
                        { currency_pair: 'USD/AOA', sell_rate: p.usd_rate },
                        { currency_pair: 'EUR/AOA', sell_rate: p.eur_rate },
                        { currency_pair: 'USDT/AOA', sell_rate: p.usdt_rate },
                    ].filter(r => r.sell_rate !== null)
                }));

                const tabsContainer = document.getElementById('informal-province-tabs');
                tabsContainer.innerHTML = allInformalProviders.map((prov, index) =>
                    `<button data-provider-id="${prov.id}" class="admin-tab whitespace-nowrap py-3 px-2 border-b-2 font-medium text-sm ${index === 0 ? 'active-tab' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">${prov.name}</button>`
                ).join('');

                if (allInformalProviders.length > 0) {
                    renderInformalContent(allInformalProviders[0].id);
                } else {
                    contentContainer.innerHTML = '<p class="text-slate-500">Nenhum mercado informal encontrado.</p>';
                }
            } catch (error) {
                contentContainer.innerHTML = 'Erro ao carregar.';
            }
        }

        function renderInformalContent(providerId) {
            const contentContainer = document.getElementById('informal-rates-content');
            const provider = allInformalProviders.find(p => p.id == providerId);
            if (!provider) { contentContainer.innerHTML = '<p class="text-gray-500">Província não encontrada.</p>'; return; }

            const requiredPairs = ['USD/AOA', 'EUR/AOA', 'USDT/AOA']; // eslint-disable-line
            let content = `<div class="relative w-full max-w-sm mx-auto"><div class="absolute -top-10 right-0 flex items-center space-x-2"><button class="edit-province-btn p-1 text-slate-400 hover:text-indigo-600" data-id="${provider.id}" data-name="${provider.name}" title="Editar Nome"><svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button><button class="delete-province-btn p-1 text-slate-400 hover:text-red-500" data-id="${provider.id}" data-name="${provider.name}" title="Apagar Província"><svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><form id="informal-form" data-provider-id="${provider.id}" class="space-y-4">`;
            requiredPairs.forEach(pair => {
                const existingRate = provider.exchange_rates.find(r => r.currency_pair === pair);
                content += `<div><label class="block text-sm font-medium text-gray-700">${pair}</label><input type="text" data-rate-id="${existingRate?.id || ''}" data-pair="${pair}" value="${(existingRate?.sell_rate || 0).toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}" class="mt-1" inputmode="decimal"></div>`;
            });
            content += `<div class="flex items-center space-x-4 pt-2"><button type="submit" class="btn-primary">Guardar Taxas</button></div></form></div>`;
            contentContainer.innerHTML = content;
        }

        async function loadAffiliateLinks() {
            const tableBody = document.getElementById('affiliates-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center h-48"><div class="loader mx-auto"></div></td></tr>`;
            try {
                const data = await apiCall('/api/affiliate_links', 'GET');
                allAffiliates = data;
                renderAffiliates(allAffiliates);
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Erro ao carregar links.</td></tr>`;
            }
        }

        function renderAffiliates(links) {
            const tableBody = document.getElementById('affiliates-table-body');
            tableBody.innerHTML = links.length === 0
                ? `<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhum link de afiliado encontrado.</td></tr>`
                : links.map(link => `
                <tr data-link-id="${link.id}">
                    <td class="px-6 py-4"><div class="font-medium text-gray-900">${link.title}</div><a href="${link.url}" target="_blank" class="text-xs text-indigo-600 hover:underline truncate block max-w-xs">${link.url}</a></td>
                    <td class="px-6 py-4 text-center">${new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'USD' }).format(link.price || 0)}</td>
                    <td class="px-6 py-4 text-center font-medium">${link.click_count || 0}</td>
                    <td class="px-6 py-4"><label class="toggle-switch"><input type="checkbox" class="toggle-status" data-type="affiliate" ${link.is_active ? 'checked' : ''} data-id="${link.id}"><span class="toggle-slider"></span></label></td>
                    <td class="px-6 py-4 text-center space-x-2">
                        <button class="edit-btn p-2 rounded-md text-amber-600 hover:text-amber-700 hover:bg-amber-100 transition-colors" data-type="affiliate" data-id="${link.id}" title="Editar">
                            <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button class="delete-btn p-2 rounded-md text-red-600 hover:text-red-700 hover:bg-red-100 transition-colors" data-type="affiliate" data-id="${link.id}" title="Apagar">
                            <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </td>
                </tr>`).join('');
        }

        async function loadSupporters() {
            const tableBody = document.getElementById('supporters-table-body');
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center h-48"><div class="loader mx-auto"></div></td></tr>`;
            try {
                // 1. Busca os apoiadores e as URLs dos banners em paralelo
                const [supportersData, settingsData] = await Promise.all([
                    apiCall('/api/supporters', 'GET'),
                    apiCall('/api/settings', 'GET') // Busca todas as configurações
                ]);

                // 2. Mapeia as URLs dos banners para os seus respectivos IDs de apoiador
                const bannerUrls = {};
                for (const key in settingsData) {
                    if (key.startsWith('supporter_') && key.endsWith('_banner_url')) {
                        const supporterId = key.match(/supporter_(\d+)_banner_url/)?.[1];
                        if (supporterId) {
                            bannerUrls[supporterId] = settingsData[key];
                        }
                    }
                }

                // 3. Combina os dados, adicionando a banner_url a cada apoiador
                allSupporters = supportersData.map(supporter => ({
                    ...supporter,
                    banner_url: bannerUrls[supporter.id] || supporter.logo_url // Usa banner_url ou fallback para logo_url
                })); // eslint-disable-line

                tableBody.innerHTML = allSupporters.length === 0
                    ? `<tr><td colspan="3" class="text-center p-4 text-gray-500">Nenhum apoiador encontrado.</td></tr>`
                    : allSupporters.map(supporter => `
                    <tr data-supporter-id="${supporter.id}">
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-4">
                                <img src="${supporter.banner_url || '/assets/error-state.svg'}" alt="Banner de ${supporter.name}" class="h-12 w-24 object-contain bg-slate-100 rounded-lg border border-slate-200 shadow-sm" style="min-width: 96px;" onerror="this.onerror=null; this.src='/assets/error-state.svg';">
                                <div class="flex flex-col">
                                    <span class="font-medium text-gray-900">${supporter.name}</span>
                                    ${supporter.website_url ? `<a href="${supporter.website_url}" target="_blank" class="text-xs text-indigo-600 hover:underline truncate max-w-xs">${supporter.website_url}</a>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4"><label class="toggle-switch"><input type="checkbox" class="toggle-status" data-type="supporter" ${supporter.is_active ? 'checked' : ''} data-id="${supporter.id}"><span class="toggle-slider"></span></label></td>
                        <td class="px-6 py-4 text-center space-x-2">
                            <button class="edit-btn p-2 rounded-md text-amber-600 hover:text-amber-700 hover:bg-amber-100 transition-colors" data-type="supporter" data-id="${supporter.id}" title="Editar">
                                <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                            </button>
                            <button class="delete-btn p-2 rounded-md text-red-600 hover:text-red-700 hover:bg-red-100 transition-colors" data-type="supporter" data-id="${supporter.id}" title="Apagar">
                                <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            </button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-500">Erro ao carregar apoiadores.</td></tr>`;
            }
        }

        async function loadSettings() {
            try {
                const settings = await apiCall('/api/settings', 'GET');
                document.getElementById('setting_contact_email').value = settings.contact_email || '';
                document.getElementById('setting_contact_phone').value = settings.contact_phone || '';
                document.getElementById('setting_social_whatsapp').value = settings.social_media_links?.whatsapp || '';
                document.getElementById('setting_social_instagram').value = settings.social_media_links?.instagram || '';
                document.getElementById('setting_social_facebook').value = settings.social_media_links?.facebook || '';
                document.getElementById('setting_social_tiktok').value = settings.social_media_links?.tiktok || '';
                document.getElementById('setting_social_youtube').value = settings.social_media_links?.youtube || '';
            } catch (error) {
                showError('Erro ao carregar configurações.');
            }
        }

        async function loadVisaSettings() {
            try {
                const settings = await apiCall('/api/visa-settings', 'GET');
                document.getElementById('visa_setting_title').value = settings.visa_title || ''; // eslint-disable-line
                document.getElementById('visa_fee_percent').value = settings.visa_fee_percent || '';
                document.getElementById('visa_setting_min_load').value = settings.visa_min_load || '';
                document.getElementById('visa_setting_whatsapp_number').value = settings.visa_whatsapp_number || '';
                document.getElementById('visa-image-preview').src = settings.visa_image_url || '/assets/visa.png';

            } catch (error) {
                showError('Erro ao carregar configurações do Cartão Visa.');
            }
        }

        // --- Funções de Carregamento de Dados ---
        async function loadDashboardData() {
            try {
                const data = await apiCall('/api/dashboard-stats', 'GET');

                const formatNumber = (num) => {
                    if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
                    return num;
                };

                // Função auxiliar para atualizar o texto de um elemento se ele existir
                const updateTextContent = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };

                updateTextContent('today-access-stat', data.today_access ?? '0');
                updateTextContent('weekly-access-stat', formatNumber(data.weeklyViews ?? 0));
                updateTextContent('monthly-access-stat', formatNumber(data.monthlyViews ?? 0));
                updateTextContent('new-visitors-stat', data.newVisitorsToday ?? '0');
                updateTextContent('affiliate-clicks-stat', formatNumber(data.monthlyAffiliateClicks ?? 0));
                updateTextContent('online-users-stat', data.onlineUsers ?? '0');

            } catch (error) {
                console.error('Erro ao carregar estatísticas do dashboard:', error);
                displayDashboardErrorState();
            }
        }

        function displayDashboardErrorState() {
            const statCards = ['online-users-stat', 'today-access-stat', 'weekly-access-stat', 'monthly-access-stat', 'new-visitors-stat', 'error-stat', 'affiliate-clicks-stat', 'visa-clicks-stat'];
            statCards.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = `<span class="text-danger-color text-lg" title="Erro ao carregar">!</span>`;
            });
            showError('Não foi possível carregar as estatísticas do dashboard.');
        }


        // --- CHART RENDERING ---
        async function renderDashboardCharts() {
            const monthlyCtx = document.getElementById('weeklyActivityChart')?.getContext('2d');
            if (!monthlyCtx) return;

            const periodSelector = document.getElementById('activity-period-selector'); // eslint-disable-line
            const selectedValue = periodSelector.value;
            let apiUrl = '/api/weekly-activity';
            let data;

            try {
                // Constrói a URL da API com base na seleção
                if (selectedValue === 'all') {
                    apiUrl += '?months=all';
                } else if (!isNaN(selectedValue)) { // Se for um número (ex: "6", "12")
                    apiUrl += `?months=${selectedValue}`;
                } else { // Se for um formato de mês (ex: "2024-05")
                    apiUrl += `?month=${selectedValue}`;
                }

                data = await apiCall(apiUrl, 'GET');

            } catch (error) {
                monthlyCtx.canvas.parentElement.innerHTML = '<p class="text-center text-red-500">Erro ao carregar dados do gráfico.</p>';
                return;
            }

            if (_weeklyChartInstance) {
                _weeklyChartInstance.destroy();
            }

            const labels = data.map(d => d.week_start_label || d.month_name);
            const accessData = data.map(d => d.access_count);

            // Paleta de cores para as barras
            const barColors = labels.map((_, index) => {
                const colors = [
                    'rgba(79, 70, 229, 0.8)',   // Indigo
                    'rgba(59, 130, 246, 0.8)',  // Blue
                ];
                return colors[index % colors.length];
            });

            _weeklyChartInstance = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Acessos',
                        data: accessData,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: barColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                color: '#64748b' // text-slate-500
                            }
                        },
                        x: { ticks: { color: '#64748b' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function populateMonthSelector() {
            const selector = document.getElementById('monthly-drilldown-options');
            if (!selector) return;

            selector.innerHTML = ''; // Limpa opções existentes
            const uniqueMonths = new Set();

            // Usa os dados já carregados para o gráfico para obter os meses
            if (_weeklyChartInstance && _weeklyChartInstance.data.labels.length > 0) {
                _weeklyChartInstance.data.labels.forEach(label => {
                    // Assumindo que os labels mensais têm um formato que permite extrair o mês
                    // Ex: "Maio 2024". Precisamos converter para "2024-05"
                    // Esta parte pode precisar de ajuste dependendo do formato exato do `month_name`
                    const date = new Date(label); // Tenta converter o label para data
                    if (!isNaN(date)) {
                        uniqueMonths.add(date.toISOString().substring(0, 7));
                    }
                });
            }
        }
        async function loadRecentActivity() {
            const feedContainer = document.getElementById('realtime-feed');
            try {
                const response = await apiCall('/api/recent-activity?limit=50', 'GET');
                feedContainer.innerHTML = '';
                activitySessions.clear();

                if (response.length === 0) {
                    feedContainer.innerHTML = '<p class="text-sm text-slate-400 text-center py-8">Nenhuma atividade recente.</p>';
                    return;
                }

                // Agrupa as atividades por session_id
                response.forEach(activity => {
                    if (!activitySessions.has(activity.session_id)) {
                        activitySessions.set(activity.session_id, []);
                    }
                    activitySessions.get(activity.session_id).push(activity);
                });

                // Renderiza cada grupo de sessão, do mais recente para o mais antigo
                filterActivityFeed(null); // Renderiza o feed sem filtros
            } catch (error) {
                feedContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-8">Erro ao carregar atividade.</p>';
            }
        }

        async function renderEventTypesChart() {
            const chartContainer = document.getElementById('event-types-chart-container');
            const chartCtx = document.getElementById('eventTypesChart')?.getContext('2d');
            const legendContainer = document.getElementById('event-types-legend');
            if (!chartCtx) return;

            // Mapeamento de event_type para nomes legíveis
            const eventTypeTranslations = {
                'page_view': 'Visita à Página',
                'affiliate_click': 'Clique em Parceiro',
                'buy_now_click': 'Clique "Comprar"',
                'tab_switch': 'Troca de Aba',
                'supporter_click': 'Clique em Apoiador',
                'first_visit': 'Primeira Visita'
            };

            try {
                const data = await apiCall('/api/event-types-stats', 'GET');

                if (!data || data.length === 0) {
                    chartContainer.innerHTML = `<p class="text-sm text-slate-400">Sem dados de eventos.</p>`;
                    if (legendContainer) legendContainer.innerHTML = '';
                    return;
                }

                if (_eventTypesChartInstance) _eventTypesChartInstance.destroy();

                const labels = data.map(d => eventTypeTranslations[d.event_type] || d.event_type);
                const counts = data.map(d => d.count);
                const backgroundColors = ['rgba(52, 211, 153, 0.8)', 'rgba(96, 165, 250, 0.8)', 'rgba(251, 191, 36, 0.8)', 'rgba(248, 113, 113, 0.8)', 'rgba(167, 139, 250, 0.8)'];

                _eventTypesChartInstance = new Chart(chartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Contagem de Eventos',
                            data: counts,
                            backgroundColor: backgroundColors,
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }, // Desativa a legenda padrão do Chart.js
                            tooltip: { enabled: true }
                        },
                        scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                        onClick: (event) => {
                            const elements = _eventTypesChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                            if (elements.length > 0) {
                                const clickedElement = elements[0];
                                const eventType = _eventTypesChartInstance.data.labels[clickedElement.index];
                                if (eventType) {
                                    filterActivityFeed(eventType);
                                    // Scroll para a secção de atividade
                                    document.getElementById('activity-feed-title').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }
                        }
                    }
                });

                // Gera a legenda HTML personalizada
                if (legendContainer) {
                    legendContainer.innerHTML = labels.map((label, index) => `
                    <div class="legend-item flex items-center justify-between p-1 rounded hover:bg-slate-100" data-event-type="${label}">
                        <div class="flex items-center gap-2">
                            <span class="h-3 w-3 rounded-full" style="background-color: ${backgroundColors[index % backgroundColors.length]}"></span>
                            <span class="font-medium text-slate-600">${label}</span>
                        </div>
                        <span class="font-bold text-slate-800">${counts[index]}</span>
                    </div>
                `).join('');

                    // Adiciona event listeners para os itens da legenda
                    legendContainer.querySelectorAll('.legend-item').forEach(item => {
                        item.addEventListener('click', () => filterActivityFeed(item.dataset.eventType));
                    });
                }

            } catch (error) {
                chartContainer.innerHTML = `<p class="text-xs text-red-500">Erro ao carregar dados.</p>`;
            }
        }
        // --- UI & ANIMATIONS ---
        function initAnimations() {
            document.querySelectorAll('#dashboard .stat-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 100}ms`;
                card.classList.add('fade-in-up');
            });
        }

        function setupEventListeners() {
            window.addEventListener('hashchange', () => updateViewForHash(window.location.hash));
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const newHash = e.currentTarget.getAttribute('href');
                    if (window.location.hash !== newHash) window.location.hash = newHash;
                    if (window.innerWidth < 1024) document.querySelector('.sidebar').classList.add('-translate-x-full');
                });
            });
            document.getElementById('open-sidebar-btn')?.addEventListener('click', () => document.querySelector('.sidebar').classList.remove('-translate-x-full'));
            document.getElementById('close-sidebar-btn')?.addEventListener('click', () => document.querySelector('.sidebar').classList.add('-translate-x-full'));
            [document.getElementById('add-bank-btn'), document.getElementById('add-bank-quick-btn')].forEach(btn => btn?.addEventListener('click', () => openBankModal()));
            document.getElementById('add-supporter-btn')?.addEventListener('click', () => openSupporterModal());
            document.getElementById('add-currency-btn')?.addEventListener('click', () => openCurrencyModal());

            document.getElementById('sidebar-overlay')?.addEventListener('click', () => document.querySelector('.sidebar').classList.add('-translate-x-full'));
            document.getElementById('add-province-btn')?.addEventListener('click', handleAddProvince);
            document.getElementById('activity-period-selector')?.addEventListener('change', renderDashboardCharts);
            document.getElementById('clear-activity-filter-btn')?.addEventListener('click', () => filterActivityFeed(null));
            document.getElementById('visa_image_upload')?.addEventListener('change', handleVisaImagePreview);
            document.getElementById('reset-stats-btn')?.addEventListener('click', handleResetStats);
            document.getElementById('force-refresh-btn')?.addEventListener('click', handleForceRefresh);
            document.getElementById('bank-search-input')?.addEventListener('input', handleBankSearch);
            document.getElementById('visa-settings-form')?.addEventListener('submit', handleVisaSettingsFormSubmit);
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('affiliate-search-input')?.addEventListener('input', handleAffiliateSearch);
            document.body.addEventListener('click', handleGlobalClick);
            document.body.addEventListener('change', handleGlobalChange);
            document.body.addEventListener('submit', handleGlobalSubmit);
        }

        // --- WEBSOCKET & REALTIME ---
        function connectAdminWebSocket() {
            console.log('🔌 A tentar conectar ao WebSocket do admin...');
            // Adicionado para evitar erro se o elemento não existir
            const onlineUsersEl = document.getElementById('online-users-stat');
            if (!onlineUsersEl) return;

            const ws = new WebSocket(`${WEBSOCKET_URL}?client=admin`);

            ws.onopen = () => {
                console.log('✅ WebSocket do admin conectado.');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // Atualiza o contador de utilizadores online
                    if (data.type === 'user_count_update') {
                        onlineUsersEl.textContent = data.count;
                    }

                    // Adiciona nova atividade ao feed em tempo real
                    if (data.type === 'new_user_activity') {
                        const activity = data.payload;
                        const sessionId = activity.session_id;

                        let sessionActivities = activitySessions.get(sessionId);

                        if (!activitySessions.has(sessionId)) {
                            // Nova sessão, cria um novo grupo no topo
                            sessionActivities = [];
                            activitySessions.set(sessionId, sessionActivities);
                        } else {
                            // Remove o grupo antigo para redesenhá-lo
                            document.getElementById(`session-${sessionId}`)?.remove();
                        }

                        sessionActivities.push(activity);
                        // Renderiza (ou redesenha) o grupo da sessão no topo do feed
                        renderSessionGroup(sessionId, sessionActivities, true);
                    }
                } catch (error) {
                    console.error('Erro ao processar mensagem WebSocket:', error);
                }
            };
            ws.onclose = () => setTimeout(connectAdminWebSocket, 5000); // Tenta reconectar após 5 segundos
            ws.onerror = (err) => console.error('❌ Erro no WebSocket do admin:', err);
        }

        // --- POLLING PARA ATUALIZAÇÕES REGULARES ---
        function startPolling() {
            const pollInterval = 30000; // 30 segundos
            console.log(`🔄 Polling iniciado. Verificando atualizações a cada ${pollInterval / 1000} segundos.`);

            // Usar setTimeout recursivo em vez de setInterval para evitar sobreposições
            // se uma requisição demorar mais que o intervalo.
            (async function poll() {
                console.log('🔄 A buscar atualizações...');
                try {
                    await Promise.all([
                        loadDashboardData(),
                        renderEventTypesChart()
                    ]);
                    console.log('✅ Atualizações carregadas com sucesso.');
                } catch (error) {
                    console.error('❌ Erro durante o polling:', error);
                } finally {
                    // Agenda a próxima chamada apenas depois que a atual terminar.
                    setTimeout(poll, pollInterval);
                }
            })();
        }

        function filterActivityFeed(eventType) {
            currentActivityFilter = eventType;
            const feedContainer = document.getElementById('realtime-feed');
            const titleEl = document.getElementById('activity-feed-title');
            const clearBtn = document.getElementById('clear-activity-filter-btn');

            if (feedContainer) feedContainer.innerHTML = '';

            if (eventType) {
                titleEl.innerHTML = `Atividade: <span class="text-indigo-600">${eventType}</span>`;
                clearBtn.classList.remove('hidden');
            } else {
                titleEl.textContent = 'Atividade em Tempo Real';
                clearBtn.classList.add('hidden');
            }

            const filteredSessionIds = Array.from(activitySessions.keys()).filter(sessionId => {
                if (!eventType) return true; // Se não houver filtro, mostra tudo
                return activitySessions.get(sessionId).some(activity => activity.event_type === eventType);
            });

            if (filteredSessionIds.length === 0 && feedContainer) {
                feedContainer.innerHTML = `<p class="text-sm text-slate-400 text-center py-8">Nenhuma atividade encontrada para este filtro.</p>`;
            } else {
                filteredSessionIds.reverse().forEach(sessionId => renderSessionGroup(sessionId, activitySessions.get(sessionId)));
            }
        }

        function renderSessionGroup(sessionId, activities, isRealtime = false) {
            const feedContainer = document.getElementById('realtime-feed');
            if (feedContainer && feedContainer.querySelector('p')) feedContainer.innerHTML = ''; // Limpa a mensagem "A aguardar..."

            const eventIcons = {
                page_view: '👁️',
                affiliate_click: '🔗',
                buy_now_click: '🛒',
                tab_switch: '🔄',
                supporter_click: '💖',
                first_visit: '🎉',
                default: '➡️'
            };

            const firstActivity = activities[0];
            const visitorName = firstActivity.details?.visitor_name || 'Utilizador Anónimo';
            const sessionStartTime = new Date(firstActivity.created_at).toLocaleTimeString('pt-PT');

            const sessionGroup = document.createElement('div');
            sessionGroup.id = `session-${sessionId}`;
            sessionGroup.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200/80 mb-4';

            let entriesHTML = '';
            // Garante que as atividades dentro da sessão estão ordenadas por data
            activities.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            activities.forEach(activity => {
                let eventText;
                const eventType = activity.event_type;
                const details = activity.details || {};

                switch (eventType) {
                    case 'page_view': eventText = 'visitou a página.'; break;
                    case 'affiliate_click': eventText = `clicou no parceiro: <strong>${details.product_title || '...'}</strong>.`; break;
                    case 'buy_now_click': eventText = `clicou em "Comprar Agora" para <strong>${details.product_title || '...'}</strong>.`; break;
                    case 'tab_switch': eventText = `navegou para a aba <strong>${details.tab}</strong>.`; break;
                    case 'supporter_click': eventText = `clicou no apoiador: <strong>${details.supporter_name}</strong>.`; break;
                    case 'first_visit': eventText = 'fez a sua <strong>primeira visita</strong> ao site.'; break;
                    default: eventText = `realizou a ação: <strong>${eventType}</strong>.`;
                }

                const eventIcon = eventIcons[eventType] || eventIcons.default;
                const activityDate = new Date(activity.created_at);

                entriesHTML += `<div class="flex items-start space-x-3 text-sm text-slate-600 py-2 border-b border-slate-100 last:border-b-0"><div class="text-lg pt-0.5">${eventIcon}</div><div><p>${eventText}</p><span class="block text-xs text-slate-400 mt-1">${activityDate.toLocaleTimeString('pt-PT')}</span></div></div>`;
            });

            sessionGroup.innerHTML = `
            <div class="session-header text-sm font-semibold text-slate-700 mb-2">Sessão de <span class="text-indigo-600">${visitorName}</span></div>
            <div class="session-body">${entriesHTML}</div>
            <div class="session-footer text-xs text-slate-400 mt-2 text-right">Iniciada às ${sessionStartTime}</div>
        `;

            if (feedContainer) { if (isRealtime) feedContainer.prepend(sessionGroup); else feedContainer.appendChild(sessionGroup); }
        }

        async function notifyServerOfUpdate() {
            try { await apiCall('/api/notify-update'); }
            catch (error) { console.error('Falha ao notificar o servidor:', error); }
        }

        // --- UI UTILITIES (MODALS, TOASTS) ---
        function openModal(modal) {
            modal?.classList.remove('hidden');
            setTimeout(() => modal?.querySelector('.modal-content')?.classList.remove('scale-95'), 10);
        }
        function closeModal(modal) {
            modal?.querySelector('.modal-content')?.classList.add('scale-95');
            setTimeout(() => modal?.classList.add('hidden'), 300);
        }

        // --- API HELPER ---
        async function apiCall(endpoint, method = 'POST', body = null) {
            try {
                const options = {
                    method,
                    credentials: 'include', // IMPORTANTE: Inclui cookies em todas as requisições
                    headers: method !== 'GET' ? { 'Content-Type': 'application/json' } : {}
                };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const contentType = response.headers.get('content-type') || '';
                // Se a sessão expirou no servidor, garantimos erro claro aqui
                if (!response.ok) {
                    let message = 'Erro desconhecido do servidor.';
                    if (contentType.includes('application/json')) {
                        const errorResult = await response.json().catch(() => ({}));
                        if (errorResult?.message) message = errorResult.message;
                    } else if (response.status === 401) {
                        message = 'Sessão expirada. Faça login novamente.';
                    }
                    throw new Error(message);
                }
                if (!contentType.includes('application/json')) {
                    throw new Error('Sessão expirada. Faça login novamente.');
                }
                return await response.json();
            } catch (error) {
                showError(error.message);
                throw error;
            }
        }

        // --- FORM & EVENT HANDLERS ---
        function openBankModal(bankData = null) {
            const modal = document.getElementById('bank-modal');
            const form = document.getElementById('bank-form');
            form.reset();
            form.querySelector('#bank-id-input').value = bankData ? bankData.id : '';
            document.getElementById('bank-modal-title').textContent = bankData ? 'Editar Banco' : 'Adicionar Novo Banco';
            if (bankData) {
                form.querySelector('#bank_code').value = bankData.code || '';
                form.querySelector('#bank_name').value = bankData.name || '';
                form.querySelector('#bank_logo_url').value = bankData.logo_url || '';

                // Carregar taxas de câmbio
                const usdRate = bankData.usd_rate || 0;
                const eurRate = bankData.eur_rate || 0;
                const commission = bankData.fee_margin || 0;
                const baseFee = bankData.base_fee_percent || 12.0;

                form.querySelector('#bank_usd_rate').value = usdRate || '';
                form.querySelector('#bank_eur_rate').value = eurRate || '';
                form.querySelector('#bank_commission').value = commission || '';
                form.querySelector('#bank_base_fee').value = baseFee || '';
            }
            openModal(modal);
        }

        async function handleBankFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const bankData = {
                id: form.querySelector('#bank-id-input').value || null,
                code: form.querySelector('#bank_code').value,
                name: form.querySelector('#bank_name').value,
                logo_url: form.querySelector('#bank_logo_url').value || null,
                fee_margin: parseFloat(form.querySelector('#bank_commission').value) || 0,
                base_fee_percent: parseFloat(form.querySelector('#bank_base_fee').value) || 12.0,
                // Envia também as taxas iniciais para persistirem na criação
                usd_rate: parseFloat(form.querySelector('#bank_usd_rate').value) || 0,
                eur_rate: parseFloat(form.querySelector('#bank_eur_rate').value) || 0,
            };
            if (!bankData.code || !bankData.name) return showError('Por favor, preencha todos os campos.');

            try {
                const result = await apiCall('/api/bank', 'POST', bankData);
                const bankId = bankData.id || result.data?.[0]?.id;
                if (!bankId) {
                    throw new Error('Não foi possível criar/atualizar o banco. Tente novamente.');
                }
                // Feedback: mostrar sucesso, recarregar tabela e notificar usuários
                showToast(`Banco ${bankData.id ? 'atualizado' : 'adicionado'} com sucesso!`);
                closeModal(document.getElementById('bank-modal'));
                loadBanks();
                notifyServerOfUpdate();
            } catch (error) { }
        }

        function openAffiliateModal(linkData = null) {
            const modal = document.getElementById('affiliate-modal');
            const form = document.getElementById('affiliate-form');

            // Sempre reseta primeiro para limpar campos anteriores
            form.reset();

            // Atualiza título e botão
            document.getElementById('affiliate-modal-title').textContent = linkData ? 'Editar Link de Afiliado' : 'Adicionar Novo Link';
            form.querySelector('#save-affiliate-btn').textContent = linkData ? 'Guardar Alterações' : 'Adicionar';

            if (linkData) {
                // Preenche os campos com os dados existentes
                form.querySelector('#affiliate_id').value = linkData.id || '';
                form.querySelector('#affiliate_title').value = linkData.title || '';
                form.querySelector('#affiliate_url').value = linkData.url || '';
                form.querySelector('#affiliate_image_url').value = linkData.image_url || '';
                form.querySelector('#affiliate_price').value = linkData.price || '';
                form.querySelector('#affiliate_shipping').value = linkData.shipping_cost_usd || '';
                form.querySelector('#affiliate_proof_video_url').value = linkData.proof_video_url || '';
                form.querySelector('#affiliate_tutorial_video_url').value = linkData.tutorial_video_url || '';
            } else {
                // Garante que o campo ID está vazio para um novo link
                form.querySelector('#affiliate_id').value = '';
            }

            openModal(modal);
        }

        async function handleAffiliateFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const saveButton = form.querySelector('#save-affiliate-btn');
            const originalButtonText = saveButton.textContent;

            // Validação dos campos obrigatórios
            const title = form.querySelector('#affiliate_title').value.trim();
            const url = form.querySelector('#affiliate_url').value.trim();
            const imageUrl = form.querySelector('#affiliate_image_url').value.trim();

            if (!title) {
                showError('O título do produto é obrigatório');
                return;
            }
            if (!url) {
                showError('O URL do afiliado é obrigatório');
                return;
            }

            const isEditing = form.querySelector('#affiliate_id').value;
            const affiliateData = {
                id: isEditing || null,
                title: title,
                url: url,
                image_url: imageUrl,
                price: parseFloat(form.querySelector('#affiliate_price').value) || 0,
                shipping_cost_usd: parseFloat(form.querySelector('#affiliate_shipping').value) || 0,
                proof_video_url: form.querySelector('#affiliate_proof_video_url').value || null,
                tutorial_video_url: form.querySelector('#affiliate_tutorial_video_url').value || null,
                is_active: true // Define como ativo por padrão
            };

            try {
                saveButton.disabled = true;
                saveButton.textContent = 'A guardar...';

                await apiCall('/api/affiliate', 'POST', affiliateData);
                showToast(`Link ${isEditing ? 'atualizado' : 'adicionado'} com sucesso!`);
                loadAffiliateLinks();

                if (isEditing) {
                    closeModal(document.getElementById('affiliate-modal'));
                } else {
                    form.reset(); // Limpa o formulário apenas se estiver a adicionar um novo
                }
            } catch (error) {
                console.error('Erro ao salvar afiliado:', error);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = originalButtonText;
            }
        }

        function openSupporterModal(supporterData = null) {
            const modal = document.getElementById('supporter-modal');
            const form = document.getElementById('supporter-form');
            const bannerPreview = document.getElementById('supporter_banner_preview');
            const bannerNameSpan = document.getElementById('supporter_banner_name');

            // Define o título e o texto do botão com base na ação (adicionar ou editar)
            document.getElementById('supporter-modal-title').textContent = supporterData ? 'Editar Apoiador' : 'Adicionar Novo Apoiador';
            const saveBtn = form.querySelector('#save-supporter-btn');
            saveBtn.textContent = supporterData ? 'Guardar Alterações' : 'Adicionar';

            // Sempre reseta primeiro para limpar campos anteriores
            form.reset();

            // Limpa a preview apenas se não houver dados de edição
            if (!supporterData) {
                bannerPreview.innerHTML = '<span class="text-gray-400">Prévia</span>';
                bannerNameSpan.textContent = 'Escolher imagem...';
            }

            if (supporterData) {
                // Preenche os campos com os dados do apoiador
                // Usa setTimeout para garantir que o reset foi processado antes de preencher
                setTimeout(() => {
                    const idField = form.querySelector('#supporter_id');
                    const nameField = form.querySelector('#supporter_name');
                    const websiteUrlField = form.querySelector('#supporter_website_url');
                    const bannerField = form.querySelector('#supporter_banner');

                    if (idField) idField.value = supporterData.id || '';
                    if (nameField) nameField.value = supporterData.name || '';
                    if (websiteUrlField) websiteUrlField.value = supporterData.website_url || '';

                    // Se já existe um banner, mostra a prévia e torna o campo de upload opcional
                    if (supporterData.banner_url) {
                        bannerPreview.innerHTML = `<img src="${supporterData.banner_url}" class="w-full h-full object-contain" alt="Banner atual">`;
                        bannerNameSpan.textContent = 'Banner atual';
                        if (bannerField) bannerField.required = false;
                    } else {
                        // Se não houver banner, mostra preview padrão e o campo de upload é obrigatório
                        bannerPreview.innerHTML = '<span class="text-gray-400">Prévia</span>';
                        bannerNameSpan.textContent = 'Escolher imagem...';
                        if (bannerField) bannerField.required = true;
                    }
                }, 50);
            } else {
                // Se não houver dados, apenas limpa o campo ID
                const idField = form.querySelector('#supporter_id');
                if (idField) idField.value = '';
            }

            openModal(modal);
        }

        async function handleSupporterFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const saveButton = form.querySelector('#save-supporter-btn'); // Botão de salvar
            const progressContainer = document.getElementById('supporter-upload-progress-container');
            const progressBar = document.getElementById('supporter-upload-progress-bar');
            const progressText = document.getElementById('supporter-upload-progress-text');

            try {
                // Validação dos campos
                const name = form.querySelector('#supporter_name').value.trim();
                const websiteUrl = form.querySelector('#supporter_website_url').value.trim();
                // @ts-ignore
                const bannerFile = form.querySelector('#supporter_banner').files[0];
                const supporterId = form.querySelector('#supporter_id').value;

                if (!name) {
                    showError('O nome do apoiador é obrigatório');
                    return;
                }
                if (!websiteUrl) {
                    showError('O URL do website é obrigatório');
                    return;
                }
                if (!supporterId && !bannerFile) {
                    showError('O banner é obrigatório para novos apoiadores');
                    return;
                }

                // Desabilita o botão e mostra feedback
                saveButton.disabled = true;
                saveButton.textContent = 'A enviar...';

                // Mostra a barra de progresso
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = 'A iniciar...';
                // Criar FormData para enviar o arquivo
                const formData = new FormData();
                formData.append('name', name);
                formData.append('website_url', websiteUrl);
                formData.append('is_active', 'true');

                // Adiciona o ID se estiver editando
                if (supporterId) {
                    formData.append('id', supporterId);
                }

                // Adiciona o arquivo apenas se um novo for selecionado
                if (bannerFile) {
                    formData.append('banner_image', bannerFile);
                }

                // Usar XMLHttpRequest para ter acesso ao progresso do upload
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/supporter', true);

                    // Evento para acompanhar o progresso do upload
                    xhr.upload.onprogress = function (event) {
                        if (event.lengthComputable) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                            progressText.textContent = `A enviar... ${Math.round(percentComplete)}%`;
                        }
                    };

                    // Evento para quando o upload estiver completo
                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            progressText.textContent = 'Processando no servidor...';
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            let errorMessage = 'Erro ao salvar apoiador';
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                errorMessage = errorData.message || `Erro HTTP ${xhr.status}`;
                            } catch {
                                errorMessage = `Erro HTTP ${xhr.status}`;
                            }
                            reject(new Error(errorMessage));
                        }
                    };

                    // Evento para erros de rede
                    xhr.onerror = function () {
                        reject(new Error('Erro de rede durante o upload.'));
                    };

                    xhr.send(formData);
                }).then(result => {
                    if (result.success) {
                        showToast(`Apoiador ${supporterId ? 'atualizado' : 'adicionado'} com sucesso!`);
                        closeModal(document.getElementById('supporter-modal'));
                        loadSupporters();
                    } else {
                        throw new Error(result.message || 'Erro ao salvar apoiador');
                    }
                });
            } catch (error) {
                console.error('Erro ao salvar apoiador:', error);
                showError(error.message || 'Erro ao salvar apoiador');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = form.querySelector('#supporter_id').value ? 'Guardar Alterações' : 'Adicionar';
                // Esconde a barra de progresso em caso de erro ou sucesso
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '';
            }
        }

        function openCurrencyModal(currencyData = null) {
            const modal = document.getElementById('currency-modal');
            const form = document.getElementById('currency-form');

            form.reset();

            document.getElementById('currency-modal-title').textContent = currencyData ? 'Editar Moeda' : 'Adicionar Nova Moeda';
            form.querySelector('#save-currency-btn').textContent = currencyData ? 'Guardar Alterações' : 'Adicionar';
            form.querySelector('#currency_id').value = currencyData?.id || '';

            if (currencyData) {
                form.querySelector('#currency_code').value = currencyData.code;
                form.querySelector('#currency_name').value = currencyData.name;
                form.querySelector('#currency_symbol').value = currencyData.symbol;
            }

            openModal(modal);
        }

        async function handleCurrencyFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const currencyData = {
                id: form.querySelector('#currency_id').value || null,
                code: form.querySelector('#currency_code').value.toUpperCase(),
                name: form.querySelector('#currency_name').value,
                symbol: form.querySelector('#currency_symbol').value,
            };
            try {
                await apiCall('/api/currency', 'POST', currencyData);
                showToast(`Moeda ${currencyData.id ? 'atualizada' : 'adicionada'} com sucesso!`);
                closeModal(document.getElementById('currency-modal'));
                loadCurrencies();
            } catch (error) { }
        }

        function openProvinceModal(provinceData = null) {
            const modal = document.getElementById('province-modal');
            const form = document.getElementById('province-form');
            form.reset();

            document.getElementById('province-modal-title').textContent = provinceData ? 'Editar Província' : 'Adicionar Nova Província';
            form.querySelector('#save-province-btn').textContent = provinceData ? 'Guardar Alterações' : 'Adicionar';
            form.querySelector('#province_id').value = provinceData?.id || '';
            form.querySelector('#province_name').value = provinceData?.name || '';

            openModal(modal);
        }

        async function handleProvinceFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#province_id').value;
            const name = form.querySelector('#province_name').value.trim();

            if (!name) {
                showError('O nome da província é obrigatório.');
                return;
            }

            try {
                const endpoint = id ? '/api/province' : '/api/add-province';
                const body = id ? { id, name } : { name };
                await apiCall(endpoint, 'POST', body);
                showToast(`Província ${id ? 'atualizada' : 'adicionada'} com sucesso!`);
                closeModal(document.getElementById('province-modal'));
                loadInformalRates();
                notifyServerOfUpdate();
            } catch (error) { }
        }

        function handleAddProvince() {
            openProvinceModal();
        }

        async function handleSettingsFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const socialLinks = {
                whatsapp: form.querySelector('#setting_social_whatsapp').value,
                instagram: form.querySelector('#setting_social_instagram').value,
                facebook: form.querySelector('#setting_social_facebook').value,
                tiktok: form.querySelector('#setting_social_tiktok').value,
                youtube: form.querySelector('#setting_social_youtube').value,
            };

            const settingsData = [
                { key: 'contact_email', value: form.querySelector('#setting_contact_email').value },
                { key: 'contact_phone', value: form.querySelector('#setting_contact_phone').value },
                { key: 'social_media_links', value: socialLinks },
            ];

            try {
                await apiCall('/api/settings', 'POST', { settings: settingsData });
                showToast('Configurações guardadas com sucesso!');
                notifyServerOfUpdate();
            } catch (e) { }

        }

        function handleVisaImagePreview(event) {
            const input = event.target;
            const file = input.files[0];
            const preview = document.getElementById('visa-image-preview');
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (file) {
                // Validação de tamanho
                if (file.size > maxSize) {
                    showError('O arquivo é muito grande. O tamanho máximo é 5MB.');
                    input.value = ''; // Limpa o input
                    return;
                }
                // Validação de tipo
                if (!file.type.startsWith('image/')) {
                    showError('Por favor, selecione um arquivo de imagem válido.');
                    input.value = ''; // Limpa o input
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else {
                // Se o usuário cancelar a seleção, podemos reverter para a imagem original se tivermos o URL guardado
                // Por agora, não fazemos nada, mantendo a imagem que estava antes.
                // Se quiser reverter, precisaria guardar o `src` original antes de abrir o seletor de arquivos.
            }
        }


        function setupSupporterBannerPreview() {
            const bannerInput = document.getElementById('supporter_banner');
            if (!bannerInput) return;

            const clearFileInput = () => {
                const input = document.getElementById('supporter_banner');
                input.value = ''; // Limpa o input
                document.getElementById('supporter_banner_name').textContent = 'Escolher imagem...';
                document.getElementById('supporter_banner_preview').innerHTML = '<span class="text-gray-400">Prévia</span>';
            };

            bannerInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                const preview = document.getElementById('supporter_banner_preview');
                const nameSpan = document.getElementById('supporter_banner_name');
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (file) {
                    if (file.size > maxSize) {
                        showError('O arquivo é muito grande. O tamanho máximo é 5MB.');
                        clearFileInput();
                        return;
                    }

                    if (!file.type.startsWith('image/')) {
                        showError('Por favor, selecione apenas arquivos de imagem.');
                        clearFileInput();
                        return;
                    }

                    nameSpan.textContent = file.name;

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        preview.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-contain">`;

                        const img = new Image();
                        img.onload = function () {
                            if (this.width < 500 || this.height < 200) {
                                showError(`A imagem é muito pequena. Recomenda-se pelo menos 500x200 pixels.`);
                                clearFileInput();
                            }
                        };
                        img.src = event.target.result;
                    }
                    reader.onerror = function () {
                        showError('Erro ao ler o arquivo. Tente novamente.');
                        clearFileInput();
                    };
                    reader.readAsDataURL(file);
                } else {
                    clearFileInput();
                }
            });
        }

        async function handleVisaSettingsFormSubmit(e) { // eslint-disable-line
            e.preventDefault();
            const form = e.target;
            const saveButton = form.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.textContent;

            const progressContainer = document.getElementById('visa-upload-progress-container');
            const progressBar = document.getElementById('visa-upload-progress-bar');
            const progressText = document.getElementById('visa-upload-progress-text');

            const formData = new FormData(form);

            saveButton.disabled = true;
            saveButton.textContent = 'A guardar...';

            // Mostra a barra de progresso se um arquivo foi selecionado
            if (document.getElementById('visa_image_upload').files.length > 0) {
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = 'A iniciar upload...';
            }

            try {
                // Usar XMLHttpRequest para monitorar o progresso do upload
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/visa-settings', true);
                    xhr.credentials = true; // Equivalente ao 'credentials: include' do fetch

                    xhr.upload.onprogress = function (event) {
                        if (event.lengthComputable) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                            progressText.textContent = `A enviar imagem... ${Math.round(percentComplete)}%`;
                        }
                    };

                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            progressText.textContent = 'Processando no servidor...';
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            const errorData = JSON.parse(xhr.responseText);
                            reject(new Error(errorData.message || `Erro HTTP ${xhr.status}`));
                        }
                    };

                    xhr.onerror = function () {
                        reject(new Error('Erro de rede durante o upload.'));
                    };

                    xhr.send(formData);
                });

                showToast('Configurações do Cartão Visa guardadas com sucesso!');
                if (result.newImageUrl) {
                    document.getElementById('visa-image-preview').src = result.newImageUrl;
                }
                // Limpa o input de arquivo para evitar reenvio acidental
                document.getElementById('visa_image_upload').value = '';

            } catch (e) {
                console.error('Error updating Visa settings:', e);
                showError(e.message || 'Erro desconhecido ao guardar as configurações do Cartão Visa.');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = originalButtonText;
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '';
            }
        }

        function handleBankSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            renderBanks(searchTerm ? allFormalProviders.filter(b => b.name.toLowerCase().includes(searchTerm) || b.code.toLowerCase().includes(searchTerm)) : allFormalProviders);
        }

        function handleAffiliateSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            renderAffiliates(searchTerm ? allAffiliates.filter(a => a.title.toLowerCase().includes(searchTerm)) : allAffiliates);
        }

        async function handleInformalRateSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const providerId = form.dataset.providerId;
            const inputs = form.querySelectorAll('input[type="text"]');
            const saveButton = form.querySelector('button[type="submit"]');

            const rates = Array.from(inputs).map(input => ({
                id: input.dataset.rateId || undefined,
                provider_id: parseInt(providerId),
                currency_pair: input.dataset.pair,
                sell_rate: parseFloat(input.value.replace(',', '.')) || 0
            }));

            try {
                await apiCall('/api/informal-rates', 'POST', { rates });
                saveButton.textContent = 'Guardado!';
                showToast('Taxas guardadas!');
                setTimeout(() => {
                    saveButton.textContent = 'Guardar Taxas';
                    loadInformalRates();
                    notifyServerOfUpdate();
                }, 1500);
            } catch (error) { }
        }

        function handleGlobalClick(e) {
            const target = e.target;

            // Lógica para fechar modais
            const hideButton = target.closest('[data-modal-hide]');
            if (hideButton) {
                const modalId = hideButton.getAttribute('data-modal-hide');
                const modalToHide = document.getElementById(modalId);
                if (modalToHide) closeModal(modalToHide);
            }

            // 1. Lógica para edição in-loco, que não depende de 'data-type'
            if (target.matches('.editable-cell') && !target.querySelector('input')) {
                handleCellEdit(target);
                return; // Ação tratada, sai da função
            }

            // 2. Lógica para abas do mercado informal
            const informalTab = target.closest('.admin-tab');
            if (informalTab && !informalTab.classList.contains('active-tab')) {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active-tab'));
                informalTab.classList.add('active-tab');
                renderInformalContent(informalTab.dataset.providerId);
                return; // Ação tratada, sai da função
            }

            // 3. Lógica para botões de editar/apagar província
            const provinceEditBtn = target.closest('.edit-province-btn');
            if (provinceEditBtn) {
                const { id, name } = provinceEditBtn.dataset;
                handleEditProvince(id, name);
                return;
            }

            const provinceDeleteBtn = target.closest('.delete-province-btn');
            if (provinceDeleteBtn) {
                const { id, name } = provinceDeleteBtn.dataset;
                handleDeleteProvince(id, name);
                return;
            }

            // Lógica para o botão "Adicionar Link"
            if (target.matches('#add-affiliate-btn')) {
                openAffiliateModal(); // Chama sem argumentos para criar um novo
                return;
            }

            // 3. Lógica para botões de ação (Editar, Apagar) que usam 'data-type'
            const btn = target.closest('[data-type]');
            if (btn) {
                const { type, id, name } = btn.dataset;
                if (btn.matches('.edit-btn')) {
                    if (type === 'bank') {
                        openBankModal(allFormalProviders.find(b => String(b.id) === String(id)));
                    } else if (type === 'affiliate') {
                        const affiliate = allAffiliates.find(a => {
                            // Compara como strings para evitar problemas de tipo (ex: '1' vs 1)
                            return String(a.id) === String(id);
                        });
                        if (affiliate) {
                            openAffiliateModal(affiliate);
                        } else {
                            showError('Link de afiliado não encontrado. Tente atualizar a página.');
                        }
                    } else if (type === 'currency') {
                        openCurrencyModal(allCurrencies.find(c => String(c.id) === String(id)));
                    } else if (type === 'supporter') {
                        const supporter = allSupporters.find(s => String(s.id) === String(id));
                        if (supporter) {
                            openSupporterModal(supporter);
                        } else {
                            showError('Apoiador não encontrado. Tente atualizar a página.');
                        }
                    }
                } else if (btn.matches('.delete-btn')) {
                    if (type === 'bank') { handleDeleteBank(id); }
                    else if (type === 'affiliate') { handleDeleteAffiliate(id); }
                    else if (type === 'currency') { handleDeleteCurrency(id); }
                    else if (type === 'supporter') { handleDeleteSupporter(id); }
                }
            }
        }

        async function handleGlobalChange(e) {
            if (e.target.matches('.toggle-status')) {
                const target = e.target;
                const { id, type } = target.dataset;
                const isActive = target.checked;
                try {
                    const endpoint = '/api/update-status';
                    const body = { type, id, isActive };

                    await apiCall(endpoint, 'POST', body);
                    showToast('Status atualizado.');
                    if (type === 'bank') {
                        loadDashboardData();
                        notifyServerOfUpdate();
                    }
                } catch (error) {
                    target.checked = !isActive;
                }
            }
        }

        function handleGlobalSubmit(e) {
            e.preventDefault();
            const formId = e.target.id;
            if (formId === 'bank-form') handleBankFormSubmit(e);
            else if (formId === 'affiliate-form') handleAffiliateFormSubmit(e);
            else if (formId === 'currency-form') handleCurrencyFormSubmit(e);
            else if (formId === 'supporter-form') handleSupporterFormSubmit(e);
            else if (formId === 'informal-form') handleInformalRateSubmit(e);
            else if (formId === 'province-form') handleProvinceFormSubmit(e);
            else if (formId === 'settings-form') handleSettingsFormSubmit(e);
            else if (formId === 'visa-settings-form') handleVisaSettingsFormSubmit(e);
        }

        async function handleLogout() {
            try {
                await apiCall('/api/logout', 'POST');
                window.location.href = '/login.html';
            } catch (error) {
                showError('Não foi possível sair. Tente novamente.');
            }
        }

        function handleDeleteBank(id) {
            showDeleteConfirmation('Apagar este banco é irreversível. Deseja continuar?', async () => {
                try {
                    await apiCall(`/api/bank/${id}`, 'DELETE');
                    showToast('Banco apagado com sucesso.');
                    loadBanks();
                    loadDashboardData();
                    notifyServerOfUpdate();
                } catch (error) { }
            });
        }

        function handleDeleteAffiliate(id) {
            showDeleteConfirmation('Tem a certeza que quer apagar este link?', async () => {
                try {
                    await apiCall(`/api/affiliate/${id}`, 'DELETE');
                    showToast('Link apagado com sucesso.');
                    loadAffiliateLinks();
                } catch (error) { }
            });
        }

        function handleDeleteSupporter(id) {
            showDeleteConfirmation('Tem a certeza que quer apagar este apoiador?', async () => {
                try {
                    await apiCall(`/api/supporter/${id}`, 'DELETE');
                    showToast('Apoiador apagado com sucesso.');
                    loadSupporters();
                } catch (error) { }
            });
        }

        function handleDeleteCurrency(id) {
            showDeleteConfirmation('Tem a certeza que quer apagar esta moeda?', async () => {
                try {
                    await apiCall(`/api/currency/${id}`, 'DELETE');
                    showToast('Moeda apagada com sucesso.');
                    loadCurrencies();
                } catch (error) { }
            });
        }

        function handleDeleteProvince(id, name) {
            showDeleteConfirmation(`Tem a certeza que deseja apagar a província "${name}"?`, async () => {
                try {
                    await apiCall(`/api/province/${id}`, 'DELETE');
                    showToast('Província apagada com sucesso.');
                    loadInformalRates();
                    notifyServerOfUpdate();
                } catch (error) { }
            });
        }

        async function handleEditProvince(id, currentName) {
            // Abre o novo modal com os dados da província para edição
            openProvinceModal({ id, name: currentName });
        }

        async function handleCellEdit(cell) {
            const originalValue = cell.textContent.trim();
            const isCommission = cell.dataset.field === 'fee_margin' || cell.dataset.field === 'base_fee_percent';

            // Extrair o valor numérico original, tratando formatação pt-PT
            // Remove % para comissões, depois limpa formatação de milhares
            let cleanValue = originalValue.replace('%', '').trim();

            // Parse baseado no formato pt-PT: 1.095,39 -> 1095.39
            // Se tem ponto E vírgula, ponto é milhar e vírgula é decimal
            let originalNumber;
            if (cleanValue.includes('.') && cleanValue.includes(',')) {
                originalNumber = parseFloat(cleanValue.replace(/\./g, '').replace(',', '.'));
            } else if (cleanValue.includes(',')) {
                originalNumber = parseFloat(cleanValue.replace(',', '.'));
            } else {
                originalNumber = parseFloat(cleanValue.replace(/[^0-9.]/g, ''));
            }

            const input = document.createElement('input');
            input.type = 'text'; input.inputMode = 'decimal';

            // Formata o valor para o input usando vírgula (pt-PT)
            if (!isNaN(originalNumber) && originalNumber !== 0) {
                input.value = originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 });
            } else {
                input.value = '0,00';
            }

            input.className = 'w-full bg-yellow-100 border-indigo-500 border-2 rounded px-2 py-1 text-sm';
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            const saveChanges = async () => {
                let newValue = parseFloat(input.value.replace(/[^0-9,]/g, '').replace(',', '.'));

                // Validar se o valor mudou
                if (isNaN(newValue) || newValue === originalNumber) {
                    if (isCommission) {
                        cell.textContent = `${originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}%`;
                    } else {
                        cell.textContent = originalNumber > 0
                            ? originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })
                            : '-';
                    }
                    return;
                }

                try {
                    const { field, providerId, pair } = cell.dataset;
                    const body = { field, value: newValue, providerId, pair };
                    await apiCall('/api/update-cell', 'POST', body);

                    // Atualizar o texto da célula com formatação apropriada
                    if (isCommission) {
                        cell.textContent = `${newValue.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}%`;
                    } else {
                        cell.textContent = newValue > 0
                            ? newValue.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })
                            : '-';
                    }

                    showToast('Valor atualizado com sucesso.');
                    notifyServerOfUpdate();
                } catch (error) {
                    // Restaurar valor original em caso de erro
                    if (isCommission) {
                        cell.textContent = `${originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}%`;
                    } else {
                        cell.textContent = originalNumber > 0
                            ? originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })
                            : '-';
                    }
                }
            };

            const cancelEdit = () => {
                if (isCommission) {
                    cell.textContent = `${originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })}%`;
                } else {
                    cell.textContent = originalNumber > 0
                        ? originalNumber.toLocaleString('pt-PT', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 8 })
                        : '-';
                }
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        function handleResetStats() {
            const message = 'Esta ação vai apagar TODAS as estatísticas de atividade (acessos, cliques, etc.) e zerar os contadores de cliques dos afiliados. Esta ação é IRREVERSÍVEL.';
            const onConfirm = async () => {
                try {
                    await apiCall('/api/reset-stats', 'POST');
                    showToast('Todas as estatísticas foram zeradas com sucesso.');
                    loadAllData();
                } catch (error) { }
            };

            const modal = document.getElementById('delete-confirm-modal');
            const originalConfirmBtn = document.getElementById('confirm-delete-btn');
            const inputContainer = document.getElementById('delete-confirm-input-container');
            const input = document.getElementById('delete-confirm-input');

            document.getElementById('delete-confirm-message').textContent = message;
            inputContainer.classList.remove('hidden');
            input.value = '';

            // Clona o botão para remover listeners antigos e o substitui no DOM
            const newConfirmBtn = originalConfirmBtn.cloneNode(true);
            originalConfirmBtn.parentNode.replaceChild(newConfirmBtn, originalConfirmBtn);

            newConfirmBtn.disabled = true; // Desabilita o novo botão

            input.oninput = () => {
                newConfirmBtn.disabled = input.value.toLowerCase() !== 'resetar';
            };

            newConfirmBtn.addEventListener('click', () => { onConfirm(); closeModal(modal); });
            modal.querySelector('#cancel-delete-btn').addEventListener('click', () => closeModal(modal), { once: true });
            openModal(modal);
        }

        async function handleForceRefresh() {
            const btn = document.getElementById('force-refresh-btn');
            const icon = document.getElementById('refresh-icon');
            const spinner = document.getElementById('refresh-spinner');
            const btnText = btn.querySelector('span');

            btn.disabled = true;
            btnText.textContent = 'A atualizar...';
            icon.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                await loadAllData();
                showToast('Dashboard atualizado com sucesso!');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Atualizar';
                icon.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        function showDeleteConfirmation(message, onConfirm) {
            const modal = document.getElementById('delete-confirm-modal');
            const inputContainer = document.getElementById('delete-confirm-input-container');
            const input = document.getElementById('delete-confirm-input');
            const confirmBtn = document.getElementById('confirm-delete-btn');

            document.getElementById('delete-confirm-message').textContent = message;

            // Esconde o campo de texto para exclusões normais
            inputContainer.classList.add('hidden');
            input.value = '';
            confirmBtn.disabled = false;

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); closeModal(modal); });
            document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(modal), { once: true });
            openModal(modal);
        }
        // --- LOGICA DA PÁGINA PÚBLICA ---
        // Adiciona um listener de cliques para os links de afiliados na página pública
        // Esta lógica deve estar no script que corre na página principal (index.html)
        // Assumindo que os links de afiliados têm um atributo `data-affiliate-id`
        document.addEventListener('click', function (e) {
            const affiliateLink = e.target.closest('a[data-affiliate-id]');

            if (affiliateLink && typeof logActivity === 'function') {
                e.preventDefault(); // Impede a navegação imediata

                const linkId = affiliateLink.dataset.affiliateId;
                const productTitle = affiliateLink.dataset.productTitle || 'Desconhecido';
                const destinationUrl = affiliateLink.href;

                // Envia o evento de clique para o servidor
                logActivity('affiliate_click', { link_id: linkId, product_title: productTitle });

                // Redireciona o usuário para o URL de destino após um pequeno atraso
                setTimeout(() => { window.location.href = destinationUrl; }, 300); // 300ms para dar tempo do evento ser enviado
            }
        });

    </script>

</html>