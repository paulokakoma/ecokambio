#!/usr/bin/expect -f

set timeout 300
set password "1234"
set server "212.90.120.135"
set email "admin@ecokambio.com"

puts "\n=== INSTALANDO CERTIFICADO SSL ===\n"

spawn ssh -o StrictHostKeyChecking=no root@$server
expect "password:"
send "$password\r"
expect "#"

# Executar Certbot
puts "\n=== EXECUTANDO CERTBOT ===\n"
send "certbot --nginx -d ecokambio.com -d www.ecokambio.com --non-interactive --agree-tos --email $email --redirect\r"

expect {
    "Successfully received certificate" {
        puts "\n‚úÖ SSL instalado com sucesso!"
        exp_continue
    }
    "Congratulations" {
        puts "\nüéâ Certificado SSL ativado!"
        exp_continue
    }
    "error" {
        puts "\n‚ùå Erro ao instalar SSL"
    }
    "#" {
        puts "\nProcesso conclu√≠do"
    }
    timeout {
        puts "\nTimeout durante instala√ß√£o do SSL"
    }
}

expect "#"

# Verificar certificados
puts "\n=== VERIFICANDO CERTIFICADOS ===\n"
send "certbot certificates\r"
expect "#"

# Testar renova√ß√£o
puts "\n=== TESTANDO RENOVA√á√ÉO AUTOM√ÅTICA ===\n"
send "certbot renew --dry-run\r"
expect "#"

puts "\n=== SSL CONFIGURADO ===\n"
puts "Acesse: https://ecokambio.com\n"

interact
